<!-- 3a1bc222-22a6-4496-a9f6-a209206f7b34 cac0392c-b700-4690-b730-43926f06ac64 -->
# 자기평가 제출 단계 구분 및 대시보드 응답 추가

## 개요

현재 자기평가 제출 기능은 1차 평가자 → 관리자 제출만 지원합니다. 피평가자 → 1차 평가자 제출 기능을 추가하고, 두 단계를 명확히 구분합니다. 또한 대시보드 3개 엔드포인트 응답에 자기평가 제출 완료 여부 정보를 추가합니다.

## 구현 계획

### 1. 도메인 엔티티 수정 (WbsSelfEvaluation)

**파일**: `src/domain/core/wbs-self-evaluation/wbs-self-evaluation.entity.ts`

- 새 필드 추가:
- `submittedToEvaluator: boolean` (기본값 false)
- `submittedToEvaluatorAt: Date | null`
- `submittedToManager: boolean` (기존 `isCompleted`를 이 필드로 변경)
- `submittedToManagerAt: Date | null`
- 기존 `isCompleted`, `completedAt` 필드를 `submittedToManager`, `submittedToManagerAt`로 변경
- 엔티티 메서드 추가/수정:
- `피평가자가_1차평가자에게_제출한다(submittedBy?: string)`: `submittedToEvaluator`를 true로 설정
- `1차평가자가_관리자에게_제출한다(submittedBy?: string)`: `submittedToManager`를 true로 설정 (기존 `자가평가를_완료한다` 메서드 변경)
- `피평가자_제출을_취소한다()`: 피평가자 제출만 취소
- `1차평가자_제출을_취소한다()`: 1차 평가자 제출만 취소
- DTO 변환 메서드 수정: 새 필드 포함

### 2. 도메인 타입 및 인터페이스 업데이트

**파일**:

- `src/domain/core/wbs-self-evaluation/wbs-self-evaluation.types.ts`
- `src/domain/core/wbs-self-evaluation/interfaces/wbs-self-evaluation.interface.ts`

- `WbsSelfEvaluationDto`에 새 필드 추가
- `WbsSelfEvaluationDetailDto`에 새 필드 추가
- `UpdateWbsSelfEvaluationData`에 새 필드 추가 (선택적)
- `WbsSelfEvaluationFilter`에 필터링 옵션 추가 (submittedToEvaluatorOnly 등)

### 3. 도메인 서비스 메서드 추가

**파일**: `src/domain/core/wbs-self-evaluation/wbs-self-evaluation.service.ts`

- `피평가자가_1차평가자에게_제출한다(id: string, submittedBy: string, manager?: EntityManager)`: 새 메서드 추가
- 기존 `수정한다` 메서드에서 `submittedToEvaluator` 관련 로직 지원

### 4. 컨텍스트 레이어 - 핸들러 추가

**파일**: `src/context/performance-evaluation-context/handlers/self-evaluation/commands/`

- 새 핸들러 추가: `submit-wbs-self-evaluation-to-evaluator.handler.ts`
- `SubmitWbsSelfEvaluationToEvaluatorCommand` 커맨드
- `SubmitWbsSelfEvaluationToEvaluatorHandler` 핸들러
- 기존 `submit-wbs-self-evaluation.handler.ts` 수정:
- `submittedToManager`로 변경 (기존 `isCompleted` 대신)
- 배치 제출 핸들러 추가:
- `submit-all-wbs-self-evaluations-to-evaluator.handler.ts`
- `submit-wbs-self-evaluations-to-evaluator-by-project.handler.ts`

### 5. 컨텍스트 레이어 - 서비스 메서드 추가

**파일**: `src/context/performance-evaluation-context/performance-evaluation.service.ts`

- `피평가자가_1차평가자에게_자기평가를_제출한다(evaluationId: string, submittedBy: string)`: 새 메서드
- `직원의_전체_자기평가를_1차평가자에게_제출한다(employeeId: string, periodId: string, submittedBy: string)`: 새 메서드
- `프로젝트별_자기평가를_1차평가자에게_제출한다(employeeId: string, periodId: string, projectId: string, submittedBy: string)`: 새 메서드
- 기존 제출 메서드들은 1차 평가자 → 관리자 제출로 명확히 문서화

### 6. 인터페이스 레이어 - 컨트롤러 수정

**파일**: `src/interface/admin/performance-evaluation/wbs-self-evaluation-management.controller.ts`

- 새 엔드포인트 추가:
- `POST /admin/performance-evaluation/wbs-self-evaluations/:id/submit-to-evaluator` (단일 제출)
- `POST /admin/performance-evaluation/wbs-self-evaluations/employees/:employeeId/periods/:periodId/submit-to-evaluator` (전체 제출)
- `POST /admin/performance-evaluation/wbs-self-evaluations/employees/:employeeId/periods/:periodId/projects/:projectId/submit-to-evaluator` (프로젝트별 제출)
- 기존 제출 엔드포인트는 1차 평가자 → 관리자 제출로 명확히 문서화

### 7. 대시보드 응답 DTO 수정

**파일**: `src/interface/admin/dashboard/dto/employee-evaluation-period-status.dto.ts`

- `SelfEvaluationInfoDto`에 필드 추가:
- `isSubmittedToEvaluator: boolean` (전체 자기평가가 1차 평가자에게 제출 완료되었는지 여부)

**파일**: `src/interface/admin/dashboard/dto/my-evaluation-targets-status.dto.ts`

- `MyEvaluationTargetStatusResponseDto`에 자기평가 제출 정보 추가 (필요시 새 DTO 필드 추가)

**파일**: `src/interface/admin/dashboard/dto/employee-assigned-data.dto.ts`

- 자기평가 정보에 제출 상태 포함 (필요시)

### 8. 대시보드 컨텍스트 인터페이스 수정

**파일**: `src/context/dashboard-context/interfaces/dashboard-context.interface.ts`

- `selfEvaluation` 인터페이스에 `isSubmittedToEvaluator: boolean` 필드 추가

### 9. 대시보드 조회 핸들러 수정

**파일**: `src/context/dashboard-context/handlers/queries/get-employee-evaluation-period-status/self-evaluation.utils.ts`

- `자기평가_진행_상태를_조회한다` 함수 반환값에 `isSubmittedToEvaluator` 추가
- `submittedToEvaluator`가 true인 자기평가 수를 계산하여 모든 자기평가가 제출되었는지 확인

**파일**: `src/context/dashboard-context/handlers/queries/get-employee-evaluation-period-status/get-employee-evaluation-period-status.handler.ts`

- `자기평가_진행_상태를_조회한다` 호출 결과에 `isSubmittedToEvaluator` 포함

### 10. 할당 데이터 조회 핸들러 수정

**파일**: `src/context/dashboard-context/handlers/queries/get-employee-assigned-data/get-employee-assigned-data.handler.ts`

- 자기평가 정보 조회 시 `submittedToEvaluator` 상태 포함
- 응답에 자기평가 제출 완료 여부 정보 추가

## 주요 변경 사항 요약

1. **엔티티 필드 변경**:

- `isCompleted` → `submittedToManager`
- `completedAt` → `submittedToManagerAt`
- 새 필드: `submittedToEvaluator`, `submittedToEvaluatorAt`

2. **제출 단계 구분**:

- 1단계: 피평가자 → 1차 평가자 제출 (`submittedToEvaluator`)
- 2단계: 1차 평가자 → 관리자 제출 (`submittedToManager`)

3. **대시보드 응답**:

- `SelfEvaluationInfoDto.isSubmittedToEvaluator` 필드 추가
- 3개 엔드포인트 모두에 제출 완료 여부 정보 포함

## 영향받는 엔드포인트 및 로직 변경

### 1. `/admin/dashboard/{evaluationPeriodId}/employees/status` 엔드포인트

**파일**: `src/context/dashboard-context/handlers/queries/get-employee-evaluation-period-status/self-evaluation.utils.ts`

**변경 사항**:

- `자기평가_진행_상태를_조회한다` 함수에서:
- `isCompleted = true` → `submittedToManager = true`로 변경 (완료 카운트 계산)
- 반환값에 `isSubmittedToEvaluator` 추가 (모든 자기평가가 `submittedToEvaluator = true`인지 확인)
- `가중치_기반_자기평가_점수를_계산한다` 함수에서 `isCompleted = true` → `submittedToManager = true`로 변경

**이유**: 자기평가 상태 조회 시 1차 평가자 제출 완료 여부를 표시해야 하며, 점수/등급 계산은 관리자 최종 제출 후에만 가능

### 2. `/admin/dashboard/{evaluationPeriodId}/my-evaluation-targets/{evaluatorId}/status` 엔드포인트

**파일**: `src/context/dashboard-context/handlers/queries/get-my-evaluation-targets-status/get-my-evaluation-targets-status.handler.ts`

**변경 사항**: 자기평가 상태 조회 시 `self-evaluation.utils.ts`의 변경사항 적용, 피평가자의 자기평가 제출 완료 여부 표시

### 3. `/admin/dashboard/{evaluationPeriodId}/my-assigned-data` 엔드포인트

**파일**: `src/context/dashboard-context/handlers/queries/get-employee-assigned-data/`

**변경 사항**:

**3-1. `project-wbs.utils.ts`**:

- 자기평가 정보 조회 쿼리에서:
- `evaluation.isCompleted` → `evaluation.submittedToManager`로 변경
- `evaluation.submittedToEvaluator`, `evaluation.submittedToEvaluatorAt` 필드 추가
- `WbsSelfEvaluationInfo` 타입 매핑 시 새 필드 포함

**3-2. `summary-calculation.utils.ts`**:

- `calculateSelfEvaluationScore` 함수에서 `isCompleted = true` → `submittedToManager = true`로 변경 (점수 계산은 관리자 최종 제출 후에만 수행)

**3-3. `get-employee-assigned-data.handler.ts`**:

- 완료된 자기평가 카운트 계산 시 `wbs.selfEvaluation?.isCompleted` → `wbs.selfEvaluation?.submittedToManager`로 변경

**3-4. `types.ts`**:

- `WbsSelfEvaluationInfo` 인터페이스 수정:
- `isCompleted: boolean` → `submittedToEvaluator: boolean`, `submittedToEvaluatorAt?: Date`, `submittedToManager: boolean`, `submittedToManagerAt?: Date`로 변경

### 4. `/admin/dashboard/{evaluationPeriodId}/employees/{employeeId}/assigned-data` 엔드포인트

**파일**: `src/context/dashboard-context/handlers/queries/get-employee-assigned-data/`

**변경 사항**: 위 3번과 동일 (같은 핸들러 사용)

### 5. DTO 변경

**파일**: `src/interface/admin/dashboard/dto/employee-assigned-data.dto.ts`

**변경 사항**:

- `WbsSelfEvaluationDto` 클래스 수정:
- `isCompleted: boolean` 필드 제거
- `submittedToEvaluator: boolean`, `submittedToEvaluatorAt?: Date` 필드 추가
- `submittedToManager: boolean`, `submittedToManagerAt?: Date` 필드 추가

### 6. 성과평가 컨텍스트 핸들러 변경

**파일**: `src/context/performance-evaluation-context/handlers/self-evaluation/commands/`

**변경 사항**:

- 모든 자기평가 제출/초기화 핸들러에서:
- `isCompleted: true` → `submittedToManager: true`로 변경
- 새 핸들러는 `submittedToEvaluator: true`로 설정

**파일 목록**:

- `submit-wbs-self-evaluation.handler.ts`
- `submit-all-wbs-self-evaluations.handler.ts`
- `submit-wbs-self-evaluations-by-project.handler.ts`
- `reset-wbs-self-evaluation.handler.ts`
- `reset-all-wbs-self-evaluations.handler.ts`
- `reset-wbs-self-evaluations-by-project.handler.ts`

### 7. 성과평가 쿼리 핸들러 변경

**파일**: `src/context/performance-evaluation-context/handlers/self-evaluation/queries/get-wbs-self-evaluation-detail.handler.ts`

**변경 사항**: 쿼리에서 `evaluation.isCompleted` → `evaluation.submittedToManager`로 변경, `submittedToEvaluator` 필드도 포함

## 참고사항

- 기존 `isCompleted` 필드를 사용하는 모든 코드를 `submittedToManager`로 변경해야 함
- 할당 데이터 조회 시 자기평가 정보에 두 단계 제출 상태 모두 포함
- 점수/등급 계산은 관리자 최종 제출(`submittedToManager = true`) 후에만 수행
- 데이터베이스 마이그레이션은 수동 처리 필요 (컬럼 추가 및 이름 변경)
- API 문서화 시 두 단계 제출의 차이점 명확히 설명