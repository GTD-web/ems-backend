# Auth Context (ì¸ì¦ ì»¨í…ìŠ¤íŠ¸)

ì¸ì¦ ë° ì‚¬ìš©ì ì •ë³´ ê´€ë¦¬ë¥¼ ë‹´ë‹¹í•˜ëŠ” ì»¨í…ìŠ¤íŠ¸ì…ë‹ˆë‹¤.

## ğŸ“‹ ëª©ì°¨

1. [ê°œìš”](#ê°œìš”)
2. [í•µì‹¬ ê¸°ëŠ¥](#í•µì‹¬-ê¸°ëŠ¥)
3. [ì•„í‚¤í…ì²˜](#ì•„í‚¤í…ì²˜)
4. [ì£¼ìš” ì»´í¬ë„ŒíŠ¸](#ì£¼ìš”-ì»´í¬ë„ŒíŠ¸)
5. [ì‚¬ìš© ë°©ë²•](#ì‚¬ìš©-ë°©ë²•)
6. [ë°ì´í„° íë¦„](#ë°ì´í„°-íë¦„)

---

## ê°œìš”

Auth ContextëŠ” JWT í† í° ê²€ì¦ ì‹œë§ˆë‹¤ **SSO ì„œë²„ì™€ ë‚´ë¶€ Employee ë°ì´í„°ë¥¼ ìë™ìœ¼ë¡œ ë™ê¸°í™”**í•˜ì—¬ í•­ìƒ ìµœì‹  ìƒíƒœì˜ ì‚¬ìš©ì ì •ë³´ì™€ ì—­í• ì„ ìœ ì§€í•©ë‹ˆë‹¤.

### ì£¼ìš” íŠ¹ì§•

- âœ… **ìë™ ë™ê¸°í™”**: JWT ê²€ì¦ ì‹œ Employee ì •ë³´ì™€ ì—­í• ì„ ìë™ ì—…ë°ì´íŠ¸
- âœ… **CQRS íŒ¨í„´**: Command/Query ë¶„ë¦¬ë¡œ ì±…ì„ ëª…í™•í™”
- âœ… **ì—­í•  ê´€ë¦¬**: EMS-PROD ì‹œìŠ¤í…œ ì—­í• ì„ Employeeì— ì €ì¥ ë° ê´€ë¦¬
- âœ… **Upsert ì§€ì›**: ì‹ ê·œ ì‚¬ìš©ìëŠ” ìƒì„±, ê¸°ì¡´ ì‚¬ìš©ìëŠ” ì—…ë°ì´íŠ¸
- âœ… **JwtAuthGuard í†µí•©**: ì „ì—­ ì¸ì¦ ê°€ë“œì—ì„œ ìë™ìœ¼ë¡œ ì‚¬ìš©ì ë™ê¸°í™” ìˆ˜í–‰

---

## í•µì‹¬ ê¸°ëŠ¥

### 1. í† í° ê²€ì¦ ë° ì‚¬ìš©ì ë™ê¸°í™”

JWT í† í°ì„ ê²€ì¦í•˜ê³ , ë™ì‹œì— ë‹¤ìŒ ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤:

1. **SSO ì„œë²„ í† í° ê²€ì¦**
2. **SSOì—ì„œ ì§ì› ìƒì„¸ ì •ë³´ ì¡°íšŒ**
3. **Employee ì—”í‹°í‹° ìƒì„±/ì—…ë°ì´íŠ¸** (Upsert)
4. **ì—­í•  ì •ë³´ ì—…ë°ì´íŠ¸** (`EMS-PROD` ì‹œìŠ¤í…œ ì—­í• )
5. **ìµœì‹  ì‚¬ìš©ì ì •ë³´ ë°˜í™˜**

### 2. ì—­í•  í¬í•¨ ì‚¬ìš©ì ì¡°íšŒ

ì§ì› ë²ˆí˜¸ë¡œ Employee ì •ë³´ì™€ ì—­í• ì„ í•¨ê»˜ ì¡°íšŒí•©ë‹ˆë‹¤.

---

## ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Auth Context                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  AuthService    â”‚â”€â”€â”€â”€â”€â”€â”€>â”‚ VerifyAndSyncUserHandlerâ”‚ â”‚
â”‚  â”‚  (Facade)       â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚                    â”‚
â”‚         â”‚                            â”‚                    â”‚
â”‚         â”‚                            â–¼                    â”‚
â”‚         â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚         â”‚                  â”‚  SSOService      â”‚          â”‚
â”‚         â”‚                  â”‚  (Token Verify)  â”‚          â”‚
â”‚         â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚         â”‚                            â”‚                    â”‚
â”‚         â”‚                            â–¼                    â”‚
â”‚         â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚         â”‚                  â”‚  EmployeeService â”‚          â”‚
â”‚         â”‚                  â”‚  (CRUD + Roles)  â”‚          â”‚
â”‚         â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚         â”‚                                                 â”‚
â”‚         â–¼                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚  â”‚ GetUserWithRoles    â”‚                                â”‚
â”‚  â”‚ Handler             â”‚                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â–²
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  JwtAuthGuard     â”‚  (Interface Layer)
    â”‚  (Global Guard)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ì£¼ìš” ì»´í¬ë„ŒíŠ¸

### 1. AuthService

ì¸ì¦ ì»¨í…ìŠ¤íŠ¸ì˜ Facade ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.

```typescript
class AuthService {
  // í† í° ê²€ì¦ ë° ì‚¬ìš©ì ë™ê¸°í™”
  async í† í°ê²€ì¦ë°ì‚¬ìš©ìë™ê¸°í™”(
    accessToken: string,
  ): Promise<VerifyAndSyncUserResult>;

  // ì—­í•  í¬í•¨ ì‚¬ìš©ì ì¡°íšŒ
  async ì—­í• í¬í•¨ì‚¬ìš©ìì¡°íšŒ(
    employeeNumber: string,
  ): Promise<GetUserWithRolesResult>;
}
```

### 2. VerifyAndSyncUserHandler

í† í° ê²€ì¦ ë° ì‚¬ìš©ì ë™ê¸°í™”ë¥¼ ìˆ˜í–‰í•˜ëŠ” í•µì‹¬ í•¸ë“¤ëŸ¬ì…ë‹ˆë‹¤.

**ì²˜ë¦¬ íë¦„:**

1. SSO ì„œë²„ì— í† í° ê²€ì¦ ìš”ì²­
2. ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì´ë©´ `UnauthorizedException` ë°œìƒ
3. SSOì—ì„œ ì§ì› ìƒì„¸ ì •ë³´ ì¡°íšŒ
4. Employee ì—”í‹°í‹° ì¡°íšŒ (employeeNumberë¡œ)
5. ì¡´ì¬í•˜ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ìƒì„±
6. ì—­í•  ì •ë³´ ì—…ë°ì´íŠ¸ (`EMS-PROD` ì‹œìŠ¤í…œ ì—­í• )
7. ìµœì‹  ì •ë³´ ì¬ì¡°íšŒ í›„ ë°˜í™˜

### 3. GetUserWithRolesHandler

ì§ì› ë²ˆí˜¸ë¡œ ì‚¬ìš©ì ì •ë³´ì™€ ì—­í• ì„ ì¡°íšŒí•˜ëŠ” í•¸ë“¤ëŸ¬ì…ë‹ˆë‹¤.

---

## ì‚¬ìš© ë°©ë²•

### 1. JwtAuthGuardì—ì„œ ìë™ ì‚¬ìš© (ê¸°ë³¸)

Auth ContextëŠ” **JwtAuthGuardì—ì„œ ìë™ìœ¼ë¡œ ì‚¬ìš©**ë˜ë¯€ë¡œ ë³„ë„ í˜¸ì¶œì´ í•„ìš” ì—†ìŠµë‹ˆë‹¤.

```typescript
@Controller('api')
export class SomeController {
  // ì¸ì¦ì´ í•„ìš”í•œ ì—”ë“œí¬ì¸íŠ¸
  @Get('protected')
  async getProtectedData(@CurrentUser() user: AuthenticatedUser) {
    // user.rolesì— EMS-PROD ì‹œìŠ¤í…œ ì—­í• ì´ í¬í•¨ë¨
    console.log(user.roles); // ['admin', 'manager']
    return { message: 'Success', user };
  }
}
```

**ë™ì‘:**

1. í´ë¼ì´ì–¸íŠ¸ê°€ JWT í† í°ì„ í—¤ë”ì— í¬í•¨í•˜ì—¬ ìš”ì²­
2. `JwtAuthGuard`ê°€ `AuthService.í† í°ê²€ì¦ë°ì‚¬ìš©ìë™ê¸°í™”()` í˜¸ì¶œ
3. Employee ì •ë³´ì™€ ì—­í• ì´ ìë™ìœ¼ë¡œ ë™ê¸°í™”ë¨
4. `@CurrentUser()` ë°ì½”ë ˆì´í„°ë¡œ ì¸ì¦ëœ ì‚¬ìš©ì ì •ë³´ ì ‘ê·¼ ê°€ëŠ¥

### 2. ì§ì ‘ ì‚¬ìš© (íŠ¹ìˆ˜í•œ ê²½ìš°)

```typescript
@Injectable()
export class SomeService {
  constructor(private readonly authService: AuthService) {}

  async syncUserManually(accessToken: string) {
    // í† í° ê²€ì¦ ë° ì‚¬ìš©ì ë™ê¸°í™”
    const result = await this.authService.í† í°ê²€ì¦ë°ì‚¬ìš©ìë™ê¸°í™”(accessToken);

    console.log('ì‚¬ìš©ì ID:', result.user.id);
    console.log('ì´ë©”ì¼:', result.user.email);
    console.log('ì—­í• :', result.user.roles);
    console.log('ë™ê¸°í™” ì—¬ë¶€:', result.isSynced);
  }

  async getUserInfo(employeeNumber: string) {
    // ì—­í•  í¬í•¨ ì‚¬ìš©ì ì¡°íšŒ
    const result = await this.authService.ì—­í• í¬í•¨ì‚¬ìš©ìì¡°íšŒ(employeeNumber);

    if (result.user) {
      console.log('ì‚¬ìš©ì:', result.user.name);
      console.log('ì—­í• :', result.user.roles);
    }
  }
}
```

---

## ë°ì´í„° íë¦„

### JWT ê²€ì¦ ë° ë™ê¸°í™” íë¦„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      JWT Token        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ JwtAuthGuard â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                              â–¼
                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                      â”‚  AuthService     â”‚
                                      â”‚  í† í°ê²€ì¦ë°      â”‚
                                      â”‚  ì‚¬ìš©ìë™ê¸°í™”    â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                             â”‚                             â”‚
                â–¼                             â–¼                             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ SSOService   â”‚            â”‚ EmployeeServiceâ”‚             â”‚ Employee DB  â”‚
        â”‚ í† í°ê²€ì¦     â”‚            â”‚ findByNumber  â”‚             â”‚              â”‚
        â”‚ ì§ì›ì •ë³´ì¡°íšŒ â”‚            â”‚ create/update â”‚             â”‚  roles ì €ì¥  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚ updateRoles   â”‚             â”‚              â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                              â–¼
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚ AuthenticatedUserâ”‚
                                    â”‚ - id             â”‚
                                    â”‚ - email          â”‚
                                    â”‚ - roles          â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                              â–¼
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚  request['user'] â”‚
                                    â”‚  ì£¼ì… ì™„ë£Œ       â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ì¸í„°í˜ì´ìŠ¤ ì •ì˜

### AuthenticatedUserInfo

```typescript
interface AuthenticatedUserInfo {
  id: string; // Employee ID
  externalId: string; // SSO user ID
  email: string;
  name: string;
  employeeNumber: string;
  roles: string[]; // EMS-PROD ì‹œìŠ¤í…œ ì—­í• 
  status: string;
}
```

### VerifyAndSyncUserResult

```typescript
interface VerifyAndSyncUserResult {
  user: AuthenticatedUserInfo;
  isSynced: boolean; // Employee ì •ë³´ê°€ ë™ê¸°í™”ë˜ì—ˆëŠ”ì§€ ì—¬ë¶€
}
```

---

## Employee ì—”í‹°í‹° roles í•„ë“œ

Auth ContextëŠ” Employee ì—”í‹°í‹°ì— **`roles` í•„ë“œ**ë¥¼ ì¶”ê°€í•˜ì—¬ ì—­í•  ì •ë³´ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.

```typescript
@Entity('employee')
export class Employee extends BaseEntity {
  // ... ê¸°ì¡´ í•„ë“œë“¤

  @Column({
    type: 'jsonb',
    nullable: true,
    comment: 'EMS-PROD ì‹œìŠ¤í…œ ì—­í•  ëª©ë¡',
  })
  roles?: string[];
}
```

**ì €ì¥ ì˜ˆì‹œ:**

```json
{
  "roles": ["admin", "manager", "user"]
}
```

---

## ì—ëŸ¬ ì²˜ë¦¬

### 1. UnauthorizedException

- í† í°ì´ ìœ íš¨í•˜ì§€ ì•Šì€ ê²½ìš°
- SSO ì„œë²„ ê²€ì¦ ì‹¤íŒ¨

### 2. ForbiddenException

- EMS-PROD ì‹œìŠ¤í…œ ì—­í• ì´ ì—†ëŠ” ê²½ìš° (SSOService ë ˆë²¨ì—ì„œ ì²˜ë¦¬)

---

## í…ŒìŠ¤íŠ¸

```bash
# ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
npm test -- src/context/auth-context

# E2E í…ŒìŠ¤íŠ¸ (ì‹¤ì œ SSO ì—°ë™)
# .env íŒŒì¼ì— SSO ì„¤ì • í•„ìš”
npm run test:e2e -- auth-context
```

---

## ì°¸ê³  ë¬¸ì„œ

- [SSO ëª¨ë“ˆ ë¬¸ì„œ](../../domain/common/sso/README.md)
- [Employee ì„œë¹„ìŠ¤](../../domain/common/employee)
- [JwtAuthGuard](../../interface/guards/jwt-auth.guard.ts)

---

**ì‘ì„±ì¼**: 2024-10-20
**ìµœì¢… ìˆ˜ì •ì¼**: 2024-10-20
