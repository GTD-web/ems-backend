import { BaseE2ETest } from '../base-e2e.spec';
import { SeedDataScenario } from './scenarios/seed-data.scenario';
import { 
  WbsAssignmentCriteriaScenario,
  WbsAssignmentEvaluationLineScenario,
  WbsAssignmentIntegrationScenario 
} from './scenarios/wbs-assignment';

describe('WBS í• ë‹¹ ê³ ê¸‰ ê¸°ëŠ¥ (E2E)', () => {
  let testSuite: BaseE2ETest;
  let seedDataScenario: SeedDataScenario;
  let criteriaScenario: WbsAssignmentCriteriaScenario;
  let evaluationLineScenario: WbsAssignmentEvaluationLineScenario;
  let integrationScenario: WbsAssignmentIntegrationScenario;

  let evaluationPeriodId: string;
  let employeeIds: string[];
  let projectIds: string[];
  let wbsItemIds: string[];

  beforeAll(async () => {
    testSuite = new BaseE2ETest();
    await testSuite.initializeApp();

    seedDataScenario = new SeedDataScenario(testSuite);
    criteriaScenario = new WbsAssignmentCriteriaScenario(testSuite);
    evaluationLineScenario = new WbsAssignmentEvaluationLineScenario(testSuite);
    integrationScenario = new WbsAssignmentIntegrationScenario(testSuite);
  });

  afterAll(async () => {
    await testSuite.closeApp();
  });

  beforeEach(async () => {
    // ì‹œë“œ ë°ì´í„° ìƒì„±
    const seedResult = await seedDataScenario.ì‹œë“œ_ë°ì´í„°ë¥¼_ìƒì„±í•œë‹¤({
      clearExisting: true,
      useRealDepartments: false,
      useRealEmployees: false,
      scenario: 'with_period',
      projectCount: 2,
      wbsPerProject: 3,
    });

    evaluationPeriodId = seedResult.evaluationPeriodId;
    employeeIds = seedResult.employeeIds;
    projectIds = seedResult.projectIds;
    wbsItemIds = seedResult.wbsItemIds;

    console.log(`ğŸ“ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¤€ë¹„ ì™„ë£Œ - í‰ê°€ê¸°ê°„: ${evaluationPeriodId}, ì§ì›: ${employeeIds.length}ëª…, í”„ë¡œì íŠ¸: ${projectIds.length}ê°œ, WBS: ${wbsItemIds.length}ê°œ`);
  });

  describe('WBS í• ë‹¹ í›„ í‰ê°€ê¸°ì¤€ ìë™ìƒì„± ê²€ì¦', () => {
    it('WBS í• ë‹¹ ì‹œ í‰ê°€ê¸°ì¤€ì´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ëŠ”ì§€ ê²€ì¦í•œë‹¤', async () => {
      const result = await criteriaScenario.WBS_í• ë‹¹_í›„_í‰ê°€ê¸°ì¤€_ìë™ìƒì„±_ê²€ì¦_ì‹œë‚˜ë¦¬ì˜¤ë¥¼_ì‹¤í–‰í•œë‹¤(
        evaluationPeriodId,
        employeeIds[0],
        wbsItemIds[0],
        projectIds[0],
      );

      expect(result.assignmentCreated).toBe(true);
      expect(result.criteriaAutoGenerated).toBe(true);
      expect(result.verifiedEndpoints).toBeGreaterThan(0);
    });

    it('WBS í• ë‹¹ í›„ í‰ê°€ê¸°ì¤€ì„ ìˆ˜ì •í•  ìˆ˜ ìˆëŠ”ì§€ ê²€ì¦í•œë‹¤', async () => {
      const result = await criteriaScenario.WBS_í• ë‹¹_í›„_í‰ê°€ê¸°ì¤€_ìˆ˜ì •_ê²€ì¦_ì‹œë‚˜ë¦¬ì˜¤ë¥¼_ì‹¤í–‰í•œë‹¤(
        evaluationPeriodId,
        employeeIds[0],
        wbsItemIds[0],
        projectIds[0],
      );

      expect(result.assignmentCreated).toBe(true);
      expect(result.criteriaModified).toBe(true);
      expect(result.verifiedEndpoints).toBeGreaterThan(0);
    });
  });

  describe('WBS í• ë‹¹ í›„ í‰ê°€ë¼ì¸ ìë™êµ¬ì„± ê²€ì¦', () => {
    it('WBS í• ë‹¹ ì‹œ í‰ê°€ë¼ì¸ì´ ìë™ìœ¼ë¡œ êµ¬ì„±ë˜ê³  1ì°¨ í‰ê°€ìê°€ ì§€ì •ë˜ëŠ”ì§€ ê²€ì¦í•œë‹¤', async () => {
      // WBS í• ë‹¹ ì‹œ ìë™ìœ¼ë¡œ 1ì°¨/2ì°¨ í‰ê°€ìê°€ ì„¤ì •ë˜ëŠ”ì§€ ê²€ì¦
      const result = await evaluationLineScenario.WBS_í• ë‹¹_í›„_í‰ê°€ë¼ì¸_ìë™êµ¬ì„±_ê²€ì¦_ì‹œë‚˜ë¦¬ì˜¤ë¥¼_ì‹¤í–‰í•œë‹¤(
        evaluationPeriodId,
        employeeIds[0], // í”¼í‰ê°€ì
        wbsItemIds[0],
        projectIds[0],
      );

      expect(result.assignmentCreated).toBe(true);
      expect(result.evaluationLineConfigured).toBe(true);
      expect(result.primaryEvaluatorAssigned).toBe(true);
      expect(result.verifiedEndpoints).toBeGreaterThan(0);
    });

    it('WBS í• ë‹¹ í›„ 1ì°¨ í‰ê°€ìë¥¼ ë³€ê²½í•  ìˆ˜ ìˆëŠ”ì§€ ê²€ì¦í•œë‹¤', async () => {
      // ë‹¤ë¥¸ ì§ì›ì„ 1ì°¨ í‰ê°€ìë¡œ ì„¤ì •
      const newPrimaryEvaluatorId = employeeIds[1];

      const result = await evaluationLineScenario.WBS_í• ë‹¹_í›„_í‰ê°€ë¼ì¸_ìˆ˜ì •_ê²€ì¦_ì‹œë‚˜ë¦¬ì˜¤ë¥¼_ì‹¤í–‰í•œë‹¤(
        evaluationPeriodId,
        employeeIds[0],
        wbsItemIds[0],
        projectIds[0],
        newPrimaryEvaluatorId,
      );

      expect(result.assignmentCreated).toBe(true);
      expect(result.evaluationLineModified).toBe(true);
      expect(result.verifiedEndpoints).toBeGreaterThan(0);
    });
  });

  describe('WBS í• ë‹¹ í†µí•© ê²€ì¦', () => {
    it('WBS í• ë‹¹ í›„ í‰ê°€ê¸°ì¤€ê³¼ í‰ê°€ë¼ì¸ì´ ëª¨ë‘ ìë™ìœ¼ë¡œ ìƒì„±ë˜ëŠ”ì§€ í†µí•© ê²€ì¦í•œë‹¤', async () => {
      const result = await integrationScenario.WBS_í• ë‹¹_í›„_í‰ê°€ê¸°ì¤€_ë°_í‰ê°€ë¼ì¸_í†µí•©_ê²€ì¦_ì‹œë‚˜ë¦¬ì˜¤ë¥¼_ì‹¤í–‰í•œë‹¤(
        evaluationPeriodId,
        employeeIds[0],
        wbsItemIds[0],
        projectIds[0],
      );

      expect(result.assignmentCreated).toBe(true);
      expect(result.criteriaAutoGenerated).toBe(true);
      expect(result.evaluationLineConfigured).toBe(true);
      expect(result.primaryEvaluatorAssigned).toBe(true);
      expect(result.verifiedEndpoints).toBeGreaterThan(0);
    });

    it('WBS í• ë‹¹ í›„ ëŒ€ì‹œë³´ë“œì—ì„œ ëª¨ë“  ì •ë³´ê°€ ì˜¬ë°”ë¥´ê²Œ í‘œì‹œë˜ëŠ”ì§€ ê²€ì¦í•œë‹¤', async () => {
      const result = await integrationScenario.WBS_í• ë‹¹_í›„_ëŒ€ì‹œë³´ë“œ_ê²€ì¦_ì‹œë‚˜ë¦¬ì˜¤ë¥¼_ì‹¤í–‰í•œë‹¤(
        evaluationPeriodId,
        [employeeIds[0]],
        [wbsItemIds[0], wbsItemIds[1]],
        projectIds[0],
      );

      expect(result.assignments.length).toBe(2); // 1ëª… Ã— 2ê°œ WBS
      expect(result.verifiedDashboardEndpoints).toBe(1);
    });
  });
});
