# 하향평가 관리 컨트롤러 엔드포인트 로직 분석

## 개요

`DownwardEvaluationManagementController`는 하향평가의 저장(생성/수정), 제출, 초기화, 조회 기능을 제공하는 컨트롤러입니다.

**컨트롤러 경로**: `src/interface/admin/performance-evaluation/downward-evaluation-management.controller.ts`  
**기본 경로**: `/admin/performance-evaluation/downward-evaluations`

## 아키텍처 구조

```
Controller (Interface Layer)
    ↓
Business Service (Business Layer)
    ↓
Context Service (Context Layer)
    ↓
Command/Query Handlers (Application Layer)
    ↓
Domain Service (Domain Layer)
    ↓
Entity (Domain Layer)
```

## 엔드포인트 목록

### 1. 저장 (Upsert) 엔드포인트

#### 1.1 1차 하향평가 저장
- **엔드포인트**: `PUT /:evaluateeId/:periodId/:wbsId/primary`
- **메서드**: `upsertPrimaryDownwardEvaluation`
- **설명**: 1차 하향평가를 저장합니다. 기존 평가가 있으면 수정, 없으면 생성합니다.

**처리 흐름**:
1. 컨트롤러에서 요청 파라미터 추출
   - `evaluateeId`: 피평가자 ID (경로 파라미터)
   - `periodId`: 평가기간 ID (경로 파라미터)
   - `wbsId`: WBS ID (경로 파라미터)
   - `evaluatorId`: 평가자 ID (Body)
   - `downwardEvaluationContent`: 평가 내용 (Body)
   - `downwardEvaluationScore`: 평가 점수 (Body)
   - `selfEvaluationId`: 자기평가 ID (Body, 선택)
   - `actionBy`: 현재 사용자 ID

2. 비즈니스 서비스 호출: `DownwardEvaluationBusinessService.일차_하향평가를_저장한다()`
   - **평가라인 검증**: `EvaluationCriteriaManagementService.평가라인을_검증한다()`
     - 1차 평가자 권한 확인
   - **평가 점수 범위 검증**: `EvaluationPeriodManagementContextService.평가_점수를_검증한다()`
     - 점수가 있는 경우에만 검증
   - **하향평가 저장**: `PerformanceEvaluationService.하향평가를_저장한다()`
     - `UpsertDownwardEvaluationCommand` 생성 및 실행
     - `UpsertDownwardEvaluationHandler` 실행
       - 기존 평가 조회 (employeeId, evaluatorId, periodId, wbsId, evaluationType)
       - 기존 평가가 있으면 수정, 없으면 생성
       - 트랜잭션 내에서 처리

3. 응답 반환
   - `evaluationId`: 생성/수정된 평가 ID
   - `evaluatorId`: 평가자 ID
   - `message`: 성공 메시지

#### 1.2 2차 하향평가 저장
- **엔드포인트**: `PUT /:evaluateeId/:periodId/:wbsId/secondary`
- **메서드**: `upsertSecondaryDownwardEvaluation`
- **설명**: 2차 하향평가를 저장합니다. 기존 평가가 있으면 수정, 없으면 생성합니다.

**처리 흐름**:
1차 하향평가 저장과 동일하지만, `evaluationType`이 `'secondary'`로 설정됩니다.
- 평가라인 검증 시 2차 평가자 권한 확인

### 2. 제출 엔드포인트

#### 2.1 1차 하향평가 제출
- **엔드포인트**: `POST /:evaluateeId/:periodId/:wbsId/primary/submit`
- **메서드**: `submitPrimaryDownwardEvaluation`
- **설명**: 1차 하향평가를 제출하고, 해당 평가기간에 발생한 1차 하향평가에 대한 재작성 요청이 존재하면 자동 완료 처리합니다.

**처리 흐름**:
1. 컨트롤러에서 요청 파라미터 추출
   - `evaluateeId`, `periodId`, `wbsId` (경로 파라미터)
   - `evaluatorId` (Body)
   - `submittedBy`: 현재 사용자 ID

2. 비즈니스 서비스 호출: `DownwardEvaluationBusinessService.일차_하향평가를_제출하고_재작성요청을_완료한다()`
   - **1차 하향평가 제출**: `PerformanceEvaluationService.일차_하향평가를_제출한다()`
     - `GetDownwardEvaluationListQuery`로 1차 하향평가 조회
     - 평가가 없으면 예외 발생
     - `SubmitDownwardEvaluationCommand` 생성 및 실행
     - `SubmitDownwardEvaluationHandler` 실행
       - 평가 조회 및 검증
       - 이미 완료된 평가인지 확인
       - 필수 항목 검증 (내용, 점수)
       - `isCompleted: true`로 수정
   - **재작성 요청 자동 완료**: `RevisionRequestContextService.제출자에게_요청된_재작성요청을_완료처리한다()`
     - 1차평가자에게 요청된 재작성 요청 완료 처리
     - `RecipientType.PRIMARY_EVALUATOR`로 필터링

3. 응답: void (성공 시 200 OK)

#### 2.2 2차 하향평가 제출
- **엔드포인트**: `POST /:evaluateeId/:periodId/:wbsId/secondary/submit`
- **메서드**: `submitSecondaryDownwardEvaluation`
- **설명**: 2차 하향평가를 제출하고, 해당 평가기간에 발생한 2차 하향평가에 대한 재작성 요청이 존재하면 자동 완료 처리합니다.

**처리 흐름**:
1차 하향평가 제출과 동일하지만, `evaluationType`이 `'secondary'`로 설정됩니다.
- 재작성 요청 완료 처리 시 `RecipientType.SECONDARY_EVALUATOR`로 필터링

#### 2.3 하향평가 제출 (ID로 직접)
- **엔드포인트**: `POST /:id/submit`
- **메서드**: `submitDownwardEvaluation`
- **설명**: 평가 ID로 직접 하향평가를 제출합니다.

**처리 흐름**:
1. 컨트롤러에서 평가 ID 추출
2. `PerformanceEvaluationService.하향평가를_제출한다()` 호출
   - `SubmitDownwardEvaluationCommand` 생성 및 실행
   - 평가 조회, 검증, 완료 처리

#### 2.4 피평가자의 모든 하향평가 일괄 제출
- **엔드포인트**: `POST /:evaluateeId/:periodId/bulk-submit`
- **메서드**: `bulkSubmitDownwardEvaluations`
- **설명**: 피평가자의 모든 하향평가를 일괄 제출합니다.

**처리 흐름**:
1. 컨트롤러에서 요청 파라미터 추출
   - `evaluateeId`, `periodId` (경로 파라미터)
   - `evaluatorId` (Body)
   - `evaluationType` (Query 파라미터)
   - `submittedBy`: 현재 사용자 ID

2. `PerformanceEvaluationService.피평가자의_모든_하향평가를_일괄_제출한다()` 호출
   - `BulkSubmitDownwardEvaluationsCommand` 생성 및 실행
   - `BulkSubmitDownwardEvaluationsHandler` 실행
     - 해당 평가자가 담당하는 피평가자의 모든 하향평가 조회
     - 각 평가를 순회하며 제출 처리
       - 이미 완료된 평가는 건너뛰기
       - 필수 항목 누락 시 실패 처리
       - 성공/실패/건너뛴 항목 카운트 및 ID 목록 수집

3. 응답 반환
   - `submittedCount`: 제출 성공 개수
   - `skippedCount`: 건너뛴 개수
   - `failedCount`: 실패 개수
   - `submittedIds`: 제출 성공한 평가 ID 목록
   - `skippedIds`: 건너뛴 평가 ID 목록
   - `failedItems`: 실패한 평가 목록 (evaluationId, error)

### 3. 초기화 엔드포인트

#### 3.1 1차 하향평가 초기화
- **엔드포인트**: `POST /:evaluateeId/:periodId/:wbsId/primary/reset`
- **메서드**: `resetPrimaryDownwardEvaluation`
- **설명**: 1차 하향평가를 미제출 상태로 변경합니다.

**처리 흐름**:
1. 컨트롤러에서 요청 파라미터 추출
   - `evaluateeId`, `periodId`, `wbsId` (경로 파라미터)
   - `evaluatorId` (Body)
   - `resetBy`: 현재 사용자 ID

2. `PerformanceEvaluationService.일차_하향평가를_초기화한다()` 호출
   - `GetDownwardEvaluationListQuery`로 1차 하향평가 조회
   - 평가가 없으면 예외 발생
   - `ResetDownwardEvaluationCommand` 생성 및 실행
   - `ResetDownwardEvaluationHandler` 실행
     - 평가 조회 및 검증
     - 완료되지 않은 평가인지 확인
     - `isCompleted: false`로 수정

3. 응답: void (성공 시 200 OK)

#### 3.2 2차 하향평가 초기화
- **엔드포인트**: `POST /:evaluateeId/:periodId/:wbsId/secondary/reset`
- **메서드**: `resetSecondaryDownwardEvaluation`
- **설명**: 2차 하향평가를 미제출 상태로 변경합니다.

**처리 흐름**:
1차 하향평가 초기화와 동일하지만, `evaluationType`이 `'secondary'`로 설정됩니다.

#### 3.3 피평가자의 모든 하향평가 일괄 초기화
- **엔드포인트**: `POST /:evaluateeId/:periodId/bulk-reset`
- **메서드**: `bulkResetDownwardEvaluations`
- **설명**: 피평가자의 모든 하향평가를 일괄 초기화합니다.

**처리 흐름**:
1. 컨트롤러에서 요청 파라미터 추출
   - `evaluateeId`, `periodId` (경로 파라미터)
   - `evaluatorId` (Body)
   - `evaluationType` (Query 파라미터)
   - `resetBy`: 현재 사용자 ID

2. `PerformanceEvaluationService.피평가자의_모든_하향평가를_일괄_초기화한다()` 호출
   - `BulkResetDownwardEvaluationsCommand` 생성 및 실행
   - `BulkResetDownwardEvaluationsHandler` 실행
     - 해당 평가자가 담당하는 피평가자의 모든 하향평가 조회
     - 각 평가를 순회하며 초기화 처리
       - 이미 미제출 상태인 평가는 건너뛰기
       - 성공/실패/건너뛴 항목 카운트 및 ID 목록 수집

3. 응답 반환
   - `resetCount`: 초기화 성공 개수
   - `skippedCount`: 건너뛴 개수
   - `failedCount`: 실패 개수
   - `resetIds`: 초기화 성공한 평가 ID 목록
   - `skippedIds`: 건너뛴 평가 ID 목록
   - `failedItems`: 실패한 평가 목록 (evaluationId, error)

### 4. 조회 엔드포인트

#### 4.1 평가자의 하향평가 목록 조회
- **엔드포인트**: `GET /evaluators/:evaluatorId`
- **메서드**: `getEvaluatorDownwardEvaluations`
- **설명**: 평가자의 하향평가 목록을 조회합니다.

**처리 흐름**:
1. 컨트롤러에서 요청 파라미터 추출
   - `evaluatorId` (경로 파라미터)
   - 필터 조건 (Query 파라미터)
     - `evaluateeId`: 피평가자 ID
     - `periodId`: 평가기간 ID
     - `wbsId`: WBS ID
     - `evaluationType`: 평가 유형 (primary/secondary)
     - `isCompleted`: 완료 여부
     - `page`: 페이지 번호 (기본값: 1)
     - `limit`: 페이지 크기 (기본값: 10)

2. `GetDownwardEvaluationListQuery` 생성

3. `PerformanceEvaluationService.하향평가_목록을_조회한다()` 호출
   - `GetDownwardEvaluationListHandler` 실행
     - QueryBuilder를 사용하여 필터 조건 적용
     - 삭제되지 않은 평가만 조회 (`deletedAt IS NULL`)
     - 정렬: `createdAt DESC`
     - 페이지네이션 적용
     - 각 평가를 DTO로 변환

4. 응답 반환
   - `evaluations`: 하향평가 목록
   - `total`: 전체 개수
   - `page`: 현재 페이지
   - `limit`: 페이지 크기

#### 4.2 하향평가 상세정보 조회
- **엔드포인트**: `GET /:id`
- **메서드**: `getDownwardEvaluationDetail`
- **설명**: 하향평가 상세정보를 조회합니다.

**처리 흐름**:
1. 컨트롤러에서 평가 ID 추출

2. `GetDownwardEvaluationDetailQuery` 생성

3. `PerformanceEvaluationService.하향평가_상세정보를_조회한다()` 호출
   - `GetDownwardEvaluationDetailHandler` 실행
     - QueryBuilder를 사용하여 관련 엔티티 JOIN
       - Employee (피평가자)
       - Employee (평가자)
       - WbsItem
       - EvaluationPeriod
       - WbsSelfEvaluation
     - 평가가 없으면 예외 발생
     - 조회 결과를 구조화된 DTO로 변환

4. 응답 반환
   - 평가 기본 정보
   - 피평가자 정보
   - 평가자 정보
   - WBS 정보
   - 평가기간 정보
   - 자기평가 정보

## 핵심 비즈니스 로직

### 1. 평가라인 검증
- 저장 시 평가자가 해당 피평가자에 대한 평가 권한이 있는지 확인
- 1차/2차 평가자 구분하여 검증

### 2. 평가 점수 범위 검증
- 평가기간에 설정된 점수 범위 내인지 확인
- 점수가 있는 경우에만 검증

### 3. Upsert 로직
- 기존 평가 조회 (employeeId, evaluatorId, periodId, wbsId, evaluationType)
- 기존 평가가 있으면 수정, 없으면 생성
- 트랜잭션 내에서 처리

### 4. 제출 검증
- 이미 완료된 평가인지 확인
- 필수 항목 검증 (내용, 점수)
- 완료 처리 (`isCompleted: true`)

### 5. 초기화 검증
- 완료되지 않은 평가인지 확인
- 미제출 상태로 변경 (`isCompleted: false`)

### 6. 재작성 요청 자동 완료
- 1차/2차 하향평가 제출 시 해당 평가기간에 발생한 재작성 요청 자동 완료 처리
- 평가자 유형에 따라 필터링 (PRIMARY_EVALUATOR / SECONDARY_EVALUATOR)

### 7. 일괄 처리
- 피평가자의 모든 하향평가를 한 번에 처리
- 각 평가별로 성공/실패/건너뛴 항목 카운트 및 상세 정보 수집
- 트랜잭션 내에서 처리

## 예외 처리

### 주요 예외
- `DownwardEvaluationNotFoundException`: 하향평가를 찾을 수 없을 때
- `DownwardEvaluationAlreadyCompletedException`: 이미 완료된 평가를 제출하려고 할 때
- `DownwardEvaluationNotCompletedException`: 완료되지 않은 평가를 초기화하려고 할 때
- `DownwardEvaluationValidationException`: 필수 항목이 누락되었을 때

## 트랜잭션 관리

- 모든 Command Handler는 `TransactionManagerService`를 사용하여 트랜잭션 내에서 처리
- 일괄 처리 시에도 트랜잭션 내에서 처리하여 일관성 보장

## 로깅

- 모든 핸들러에서 Logger를 사용하여 처리 과정 로깅
- 디버그 레벨 로그로 상세 정보 기록
- 에러 발생 시 스택 트레이스 기록

## 관련 파일

### 컨트롤러
- `src/interface/admin/performance-evaluation/downward-evaluation-management.controller.ts`

### 비즈니스 서비스
- `src/business/downward-evaluation/downward-evaluation-business.service.ts`

### 컨텍스트 서비스
- `src/context/performance-evaluation-context/performance-evaluation.service.ts`

### 핸들러
- `src/context/performance-evaluation-context/handlers/downward-evaluation/command/upsert-downward-evaluation.handler.ts`
- `src/context/performance-evaluation-context/handlers/downward-evaluation/command/submit-downward-evaluation.handler.ts`
- `src/context/performance-evaluation-context/handlers/downward-evaluation/command/reset-downward-evaluation.handler.ts`
- `src/context/performance-evaluation-context/handlers/downward-evaluation/command/bulk-submit-downward-evaluations.handler.ts`
- `src/context/performance-evaluation-context/handlers/downward-evaluation/command/bulk-reset-downward-evaluations.handler.ts`
- `src/context/performance-evaluation-context/handlers/downward-evaluation/query/get-downward-evaluation-list.handler.ts`
- `src/context/performance-evaluation-context/handlers/downward-evaluation/query/get-downward-evaluation-detail.handler.ts`

### 도메인 서비스
- `src/domain/core/downward-evaluation/downward-evaluation.service.ts`

### 엔티티
- `src/domain/core/downward-evaluation/downward-evaluation.entity.ts`

