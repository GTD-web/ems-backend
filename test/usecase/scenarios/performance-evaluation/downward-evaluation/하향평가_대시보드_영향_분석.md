# 하향평가 엔드포인트의 대시보드 영향 분석

## 개요

하향평가 관련 엔드포인트를 수행했을 때 `dashboard.controller.ts`의 어떤 엔드포인트들이 영향을 받는지 분석한 문서입니다.

**대시보드 컨트롤러 경로**: `src/interface/admin/dashboard/dashboard.controller.ts`  
**기본 경로**: `/admin/dashboard`

## 하향평가 엔드포인트와 대시보드 영향 관계

### 1. 하향평가 저장 (Upsert) 엔드포인트

#### 1.1 1차 하향평가 저장
- **엔드포인트**: `PUT /admin/performance-evaluation/downward-evaluations/:evaluateeId/:periodId/:wbsId/primary`
- **영향**: 하향평가 데이터 생성/수정

#### 1.2 2차 하향평가 저장
- **엔드포인트**: `PUT /admin/performance-evaluation/downward-evaluations/:evaluateeId/:periodId/:wbsId/secondary`
- **영향**: 하향평가 데이터 생성/수정

**영향을 받는 대시보드 엔드포인트**:

1. **`GET /admin/dashboard/:evaluationPeriodId/employees/:employeeId/assigned-data`**
   - **메서드**: `getEmployeeAssignedData`
   - **영향 내용**:
     - WBS별 하향평가 정보 (`primaryDownwardEvaluation`, `secondaryDownwardEvaluation`) 업데이트
     - 하향평가 내용, 점수, 완료 상태 반영
     - Summary의 `primaryDownwardEvaluation`, `secondaryDownwardEvaluation` 점수/등급 계산
   - **데이터 구조**:
     ```typescript
     {
       projects: [{
         wbsList: [{
           primaryDownwardEvaluation: {
             id: string;
             content: string | null;
             score: number | null;
             isCompleted: boolean;
             // ...
           };
           secondaryDownwardEvaluation: {
             id: string;
             content: string | null;
             score: number | null;
             isCompleted: boolean;
             // ...
           };
         }]
       }],
       summary: {
         primaryDownwardEvaluation: {
           totalScore: number | null;
           grade: string | null;
         };
         secondaryDownwardEvaluation: {
           totalScore: number | null;
           grade: string | null;
         };
       }
     }
     ```

2. **`GET /admin/dashboard/:evaluationPeriodId/evaluators/:evaluatorId/employees/:employeeId/assigned-data`**
   - **메서드**: `getEvaluatorAssignedEmployeesData`
   - **영향 내용**: 위와 동일 (평가자 관점에서 조회)

3. **`GET /admin/dashboard/:evaluationPeriodId/employees/:employeeId/status`**
   - **메서드**: `getEmployeeEvaluationPeriodStatus`
   - **영향 내용**:
     - 하향평가 상태 (`downwardEvaluation.primary.status`, `downwardEvaluation.secondary.status`) 업데이트
     - 할당된 WBS 수 (`assignedWbsCount`) 유지
     - 완료된 평가 수 (`completedEvaluationCount`) 업데이트
     - 제출 상태 (`isSubmitted`) 업데이트
     - 총점/등급 (`totalScore`, `grade`) 업데이트
   - **데이터 구조**:
     ```typescript
     {
       downwardEvaluation: {
         primary: {
           evaluator: {...};
           status: 'none' | 'in_progress' | 'complete' | 'pending' | 'approved' | 'revision_requested' | 'revision_completed';
           assignedWbsCount: number;
           completedEvaluationCount: number;
           isSubmitted: boolean;
           totalScore: number | null;
           grade: string | null;
         };
         secondary: {
           evaluators: [...];
           status: 'none' | 'in_progress' | 'complete' | 'pending' | 'approved' | 'revision_requested' | 'revision_completed';
           isSubmitted: boolean;
           totalScore: number | null;
           grade: string | null;
         };
       }
     }
     ```

4. **`GET /admin/dashboard/:evaluationPeriodId/employees/status`**
   - **메서드**: `getAllEmployeesEvaluationPeriodStatus`
   - **영향 내용**: 위와 동일 (전체 직원 목록)

5. **`GET /admin/dashboard/:evaluationPeriodId/evaluators/:evaluatorId/targets/status`**
   - **메서드**: `getMyEvaluationTargetsStatus`
   - **영향 내용**: 위와 동일 (평가자 관점)

6. **`GET /admin/dashboard/:evaluationPeriodId/employees/:employeeId/complete-status`**
   - **메서드**: `getEmployeeCompleteStatus`
   - **영향 내용**:
     - 위의 모든 정보 통합
     - `primaryDownwardEvaluation`, `secondaryDownwardEvaluation` 상태/점수/등급 업데이트

### 2. 하향평가 제출 엔드포인트

#### 2.1 1차 하향평가 제출
- **엔드포인트**: `POST /admin/performance-evaluation/downward-evaluations/:evaluateeId/:periodId/:wbsId/primary/submit`
- **영향**: 하향평가 완료 처리 (`isCompleted: true`), 재작성 요청 자동 완료

#### 2.2 2차 하향평가 제출
- **엔드포인트**: `POST /admin/performance-evaluation/downward-evaluations/:evaluateeId/:periodId/:wbsId/secondary/submit`
- **영향**: 하향평가 완료 처리 (`isCompleted: true`), 재작성 요청 자동 완료

#### 2.3 하향평가 제출 (ID로 직접)
- **엔드포인트**: `POST /admin/performance-evaluation/downward-evaluations/:id/submit`
- **영향**: 하향평가 완료 처리 (`isCompleted: true`)

#### 2.4 피평가자의 모든 하향평가 일괄 제출
- **엔드포인트**: `POST /admin/performance-evaluation/downward-evaluations/:evaluateeId/:periodId/bulk-submit`
- **영향**: 여러 하향평가 일괄 완료 처리

**영향을 받는 대시보드 엔드포인트**:

제출 시에는 저장 시와 동일한 엔드포인트들이 영향을 받지만, 추가로 다음 정보가 변경됩니다:

1. **완료 상태 변경**:
   - `isCompleted: false` → `isCompleted: true`
   - `completedAt` 타임스탬프 설정

2. **상태 계산 변경**:
   - `status: 'in_progress'` → `status: 'complete'` (승인 상태에 따라 `pending`, `approved` 등으로 변경 가능)
   - `completedEvaluationCount` 증가
   - `isSubmitted: true`로 변경

3. **점수/등급 계산**:
   - 모든 할당된 WBS에 대한 평가가 완료되면 (`assignedWbsCount === completedEvaluationCount`)
   - 가중치 기반 총점 계산 (`totalScore`)
   - 등급 계산 (`grade`)

4. **Summary 업데이트**:
   - `summary.primaryDownwardEvaluation.totalScore` 계산
   - `summary.primaryDownwardEvaluation.grade` 계산
   - `summary.secondaryDownwardEvaluation.totalScore` 계산
   - `summary.secondaryDownwardEvaluation.grade` 계산

### 3. 하향평가 초기화 엔드포인트

#### 3.1 1차 하향평가 초기화
- **엔드포인트**: `POST /admin/performance-evaluation/downward-evaluations/:evaluateeId/:periodId/:wbsId/primary/reset`
- **영향**: 하향평가 미제출 상태로 변경 (`isCompleted: false`)

#### 3.2 2차 하향평가 초기화
- **엔드포인트**: `POST /admin/performance-evaluation/downward-evaluations/:evaluateeId/:periodId/:wbsId/secondary/reset`
- **영향**: 하향평가 미제출 상태로 변경 (`isCompleted: false`)

#### 3.3 피평가자의 모든 하향평가 일괄 초기화
- **엔드포인트**: `POST /admin/performance-evaluation/downward-evaluations/:evaluateeId/:periodId/bulk-reset`
- **영향**: 여러 하향평가 일괄 미제출 상태로 변경

**영향을 받는 대시보드 엔드포인트**:

초기화 시에는 제출과 반대 방향으로 변경됩니다:

1. **완료 상태 변경**:
   - `isCompleted: true` → `isCompleted: false`
   - `completedAt: null`로 변경

2. **상태 계산 변경**:
   - `status: 'complete'` → `status: 'in_progress'`
   - `completedEvaluationCount` 감소
   - `isSubmitted: false`로 변경

3. **점수/등급 초기화**:
   - 모든 할당된 WBS에 대한 평가가 완료되지 않으면
   - `totalScore: null`로 변경
   - `grade: null`로 변경

4. **Summary 업데이트**:
   - `summary.primaryDownwardEvaluation.totalScore: null`
   - `summary.primaryDownwardEvaluation.grade: null`
   - `summary.secondaryDownwardEvaluation.totalScore: null`
   - `summary.secondaryDownwardEvaluation.grade: null`

## 대시보드 엔드포인트별 상세 영향

### 1. 할당 데이터 조회 엔드포인트

#### `GET /admin/dashboard/:evaluationPeriodId/employees/:employeeId/assigned-data`
**영향 받는 데이터**:

- **WBS별 하향평가 정보**:
  - `primaryDownwardEvaluation`: 1차 하향평가 정보
    - `id`: 평가 ID
    - `content`: 평가 내용
    - `score`: 평가 점수
    - `isCompleted`: 완료 여부
    - `evaluationDate`: 평가 일자
  - `secondaryDownwardEvaluation`: 2차 하향평가 정보 (동일 구조)

- **Summary 정보**:
  - `primaryDownwardEvaluation.totalScore`: 1차 하향평가 총점 (모든 WBS 완료 시 계산)
  - `primaryDownwardEvaluation.grade`: 1차 하향평가 등급
  - `secondaryDownwardEvaluation.totalScore`: 2차 하향평가 총점 (모든 평가자, 모든 WBS 완료 시 계산)
  - `secondaryDownwardEvaluation.grade`: 2차 하향평가 등급

**계산 로직**:
- 점수 계산은 모든 할당된 WBS에 대한 평가가 완료되었을 때만 수행
- 가중치 기반 점수 계산 (WBS별 가중치 적용)
- 등급은 평가기간 설정에 따라 점수 범위로 결정

#### `GET /admin/dashboard/:evaluationPeriodId/evaluators/:evaluatorId/employees/:employeeId/assigned-data`
**영향 내용**: 위와 동일 (평가자 관점에서 조회)

### 2. 평가기간 현황 조회 엔드포인트

#### `GET /admin/dashboard/:evaluationPeriodId/employees/:employeeId/status`
**영향 받는 데이터**:

- **하향평가 상태 정보**:
  - `downwardEvaluation.primary.status`: 1차 하향평가 통합 상태
    - `none`: 평가할 WBS 없음
    - `in_progress`: 진행 중 (일부 완료)
    - `complete`: 모든 WBS 평가 완료 (승인 상태에 따라 `pending`, `approved` 등으로 변경)
  - `downwardEvaluation.primary.assignedWbsCount`: 할당된 WBS 수
  - `downwardEvaluation.primary.completedEvaluationCount`: 완료된 평가 수
  - `downwardEvaluation.primary.isSubmitted`: 제출 여부
  - `downwardEvaluation.primary.totalScore`: 총점
  - `downwardEvaluation.primary.grade`: 등급
  - `downwardEvaluation.secondary`: 2차 하향평가 정보 (동일 구조, 다중 평가자 지원)

**상태 계산 로직**:
1. 할당된 WBS가 없으면 → `none`
2. 할당된 WBS가 있고 완료된 평가가 없으면 → `in_progress`
3. 할당된 WBS가 있고 일부만 완료되면 → `in_progress`
4. 할당된 WBS가 있고 모두 완료되면 → `complete` (승인 상태에 따라 `pending`, `approved` 등으로 변경)

#### `GET /admin/dashboard/:evaluationPeriodId/employees/status`
**영향 내용**: 위와 동일 (전체 직원 목록)

#### `GET /admin/dashboard/:evaluationPeriodId/evaluators/:evaluatorId/targets/status`
**영향 내용**: 위와 동일 (평가자 관점)

### 3. 완전한 상태 조회 엔드포인트

#### `GET /admin/dashboard/:evaluationPeriodId/employees/:employeeId/complete-status`
**영향 받는 데이터**:

위의 모든 정보를 통합하여 제공:
- `primaryDownwardEvaluation`: 상태, 총 WBS 수, 완료 수, 제출 여부, 총점, 등급
- `secondaryDownwardEvaluation`: 상태, 총 WBS 수, 완료 수, 제출 여부, 총점, 등급

## 데이터 흐름

### 하향평가 저장 시

```
하향평가 저장 (Upsert)
    ↓
DownwardEvaluation 엔티티 생성/수정
    ↓
대시보드 조회 시:
    ↓
1. GetEmployeeAssignedDataQuery
   - DownwardEvaluation 조회
   - WBS별 하향평가 정보 반영
   - Summary 점수/등급 계산 (모든 WBS 완료 시)
    ↓
2. GetEmployeeEvaluationPeriodStatusQuery
   - DownwardEvaluation 조회
   - 상태 계산 (none/in_progress/complete)
   - 완료 수 계산
   - 제출 상태 확인
   - 총점/등급 계산 (모든 WBS 완료 시)
```

### 하향평가 제출 시

```
하향평가 제출
    ↓
DownwardEvaluation.isCompleted = true
DownwardEvaluation.completedAt = 현재 시간
    ↓
재작성 요청 자동 완료 처리 (해당 평가기간)
    ↓
대시보드 조회 시:
    ↓
1. 상태 변경: in_progress → complete (승인 상태에 따라 pending/approved 등)
2. completedEvaluationCount 증가
3. isSubmitted = true
4. 모든 WBS 완료 시:
   - 가중치 기반 총점 계산
   - 등급 계산
   - Summary 업데이트
```

### 하향평가 초기화 시

```
하향평가 초기화
    ↓
DownwardEvaluation.isCompleted = false
DownwardEvaluation.completedAt = null
    ↓
대시보드 조회 시:
    ↓
1. 상태 변경: complete → in_progress
2. completedEvaluationCount 감소
3. isSubmitted = false
4. 모든 WBS 완료되지 않으면:
   - totalScore = null
   - grade = null
   - Summary 초기화
```

## 점수/등급 계산 조건

### 1차 하향평가 점수/등급 계산

**조건**:
- 1차 평가자가 할당되어 있어야 함
- 할당된 모든 WBS에 대한 평가가 완료되어야 함 (`assignedWbsCount === completedEvaluationCount`)

**계산 방법**:
- 가중치 기반 점수 계산: 각 WBS의 평가 점수 × WBS 가중치의 합
- 등급 계산: 평가기간 설정의 점수 범위에 따라 등급 결정

### 2차 하향평가 점수/등급 계산

**조건**:
- 2차 평가자가 할당되어 있어야 함
- 모든 2차 평가자가 할당된 모든 WBS에 대한 평가를 완료해야 함

**계산 방법**:
- 각 평가자별 가중치 기반 점수 계산
- 모든 평가자의 점수를 평균하여 최종 점수 계산
- 등급 계산: 평가기간 설정의 점수 범위에 따라 등급 결정

## 주의사항

### 1. 피평가자 조회 시 하향평가 정보 제거

`GET /admin/dashboard/:evaluationPeriodId/my/assigned-data` (내 할당 정보 조회)에서는:
- 피평가자가 자신의 할당 정보를 조회할 때
- 상위 평가자의 하향평가 정보는 제거됨
- `primaryDownwardEvaluation: null`, `secondaryDownwardEvaluation: null`
- Summary의 하향평가 점수/등급도 `null`로 설정

### 2. 상태 통합 로직

하향평가 상태는 다음 두 가지를 통합하여 계산됩니다:
1. **하향평가 진행 상태**: `none`, `in_progress`, `complete`
2. **승인 상태**: `pending`, `approved`, `revision_requested`, `revision_completed`

**통합 로직**:
- 진행 상태가 `none`이면 → `none`
- 진행 상태가 `in_progress`이면 → `in_progress`
- 진행 상태가 `complete`이면 → 승인 상태 반환 (`pending`, `approved` 등)

### 3. 2차 평가자 다중 지원

2차 하향평가는 여러 평가자를 지원합니다:
- 각 평가자별로 상태, 할당된 WBS 수, 완료 수를 개별 관리
- 전체 상태는 모든 평가자의 상태를 통합하여 계산
- 점수/등급은 모든 평가자가 완료했을 때만 계산

## 관련 파일

### 대시보드 컨트롤러
- `src/interface/admin/dashboard/dashboard.controller.ts`

### 대시보드 서비스
- `src/context/dashboard-context/dashboard.service.ts`

### 대시보드 쿼리 핸들러
- `src/context/dashboard-context/handlers/queries/get-employee-assigned-data/get-employee-assigned-data.handler.ts`
- `src/context/dashboard-context/handlers/queries/get-employee-evaluation-period-status/get-employee-evaluation-period-status.handler.ts`
- `src/context/dashboard-context/handlers/queries/get-evaluator-assigned-employees-data.query.ts`

### 하향평가 유틸리티
- `src/context/dashboard-context/handlers/queries/get-employee-evaluation-period-status/downward-evaluation.utils.ts`
- `src/context/dashboard-context/handlers/queries/get-employee-evaluation-period-status/downward-evaluation-score.utils.ts`
- `src/context/dashboard-context/handlers/queries/get-employee-assigned-data/summary-calculation.utils.ts`
- `src/context/dashboard-context/handlers/queries/get-employee-assigned-data/project-wbs.utils.ts`

