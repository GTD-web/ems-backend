import { BaseE2ETest } from '../../../base-e2e.spec';
import { WbsAssignmentBasicScenario } from './wbs-assignment-basic.scenario';

/**
 * WBS í• ë‹¹ í›„ í‰ê°€ê¸°ì¤€ ê²€ì¦ ì‹œë‚˜ë¦¬ì˜¤ í´ë˜ìŠ¤
 * 
 * WBS í• ë‹¹ ì‹œ í‰ê°€ê¸°ì¤€ì´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ëŠ”ì§€ ê²€ì¦í•©ë‹ˆë‹¤.
 */
export class WbsAssignmentCriteriaScenario {
  private basicScenario: WbsAssignmentBasicScenario;

  constructor(private readonly testSuite: BaseE2ETest) {
    this.basicScenario = new WbsAssignmentBasicScenario(testSuite);
  }

  /**
   * WBS í‰ê°€ê¸°ì¤€ì„ ì¡°íšŒí•©ë‹ˆë‹¤.
   */
  async WBS_í‰ê°€ê¸°ì¤€ì„_ì¡°íšŒí•œë‹¤(wbsItemId: string): Promise<any> {
    const response = await this.testSuite
      .request()
      .get(`/admin/evaluation-criteria/wbs-evaluation-criteria/wbs-item/${wbsItemId}`)
      .expect(200);

    return response.body;
  }

  /**
   * WBS í‰ê°€ê¸°ì¤€ì„ ìƒì„±í•©ë‹ˆë‹¤.
   */
  async WBS_í‰ê°€ê¸°ì¤€ì„_ìƒì„±í•œë‹¤(
    wbsItemId: string,
    criteria: string,
    importance: number = 5,
  ): Promise<any> {
    const response = await this.testSuite
      .request()
      .post('/admin/evaluation-criteria/wbs-evaluation-criteria')
      .send({
        wbsItemId,
        criteria,
        importance,
      })
      .expect(201);

    return response.body;
  }

  /**
   * WBS í• ë‹¹ í›„ í‰ê°€ê¸°ì¤€ ìë™ ìƒì„± ê²€ì¦ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
   */
  async WBS_í• ë‹¹_í›„_í‰ê°€ê¸°ì¤€_ìë™ìƒì„±_ê²€ì¦_ì‹œë‚˜ë¦¬ì˜¤ë¥¼_ì‹¤í–‰í•œë‹¤(
    periodId: string,
    employeeId: string,
    wbsItemId: string,
    projectId: string,
  ): Promise<{
    assignmentCreated: boolean;
    criteriaAutoGenerated: boolean;
    verifiedEndpoints: number;
  }> {
    console.log('ğŸ“ WBS í• ë‹¹ í›„ í‰ê°€ê¸°ì¤€ ìë™ìƒì„± ê²€ì¦ ì‹œë‚˜ë¦¬ì˜¤');

    // 1. í”„ë¡œì íŠ¸ í• ë‹¹ ë¨¼ì € ìƒì„±
    console.log('ğŸ“ í”„ë¡œì íŠ¸ í• ë‹¹ ìƒì„± ì¤‘...');
    await this.basicScenario.í”„ë¡œì íŠ¸ë¥¼_ëŒ€ëŸ‰ìœ¼ë¡œ_í• ë‹¹í•œë‹¤(periodId, [projectId], [employeeId]);
    console.log('âœ… í”„ë¡œì íŠ¸ í• ë‹¹ ì™„ë£Œ');

    // 2. WBS í• ë‹¹ ì „ í‰ê°€ê¸°ì¤€ ìƒíƒœ í™•ì¸
    const criteriaBeforeAssignment = await this.WBS_í‰ê°€ê¸°ì¤€ì„_ì¡°íšŒí•œë‹¤(wbsItemId);
    const beforeCount = criteriaBeforeAssignment?.criteria?.length || 0;
    console.log(`ğŸ“ WBS í• ë‹¹ ì „ í‰ê°€ê¸°ì¤€ ìˆ˜: ${beforeCount}ê°œ`);
    console.log(`ğŸ“ WBS í• ë‹¹ ì „ í‰ê°€ê¸°ì¤€ ë°ì´í„°:`, JSON.stringify(criteriaBeforeAssignment, null, 2));

    // 3. WBS í• ë‹¹ ìƒì„±
    const assignment = await this.basicScenario.WBS_í• ë‹¹ì„_ìƒì„±í•œë‹¤(
      employeeId,
      wbsItemId,
      projectId,
      periodId,
    );
    console.log(`âœ… WBS í• ë‹¹ ìƒì„± ì™„ë£Œ: ${assignment.id}`);

    // 4. WBS í• ë‹¹ í›„ í‰ê°€ê¸°ì¤€ ìƒíƒœ í™•ì¸
    const criteriaAfterAssignment = await this.WBS_í‰ê°€ê¸°ì¤€ì„_ì¡°íšŒí•œë‹¤(wbsItemId);
    const afterCount = criteriaAfterAssignment?.criteria?.length || 0;
    console.log(`ğŸ“ WBS í• ë‹¹ í›„ í‰ê°€ê¸°ì¤€ ìˆ˜: ${afterCount}ê°œ`);
    console.log(`ğŸ“ WBS í• ë‹¹ í›„ í‰ê°€ê¸°ì¤€ ë°ì´í„°:`, JSON.stringify(criteriaAfterAssignment, null, 2));

    // 5. í‰ê°€ê¸°ì¤€ ìë™ ìƒì„± ê²€ì¦
    const criteriaAutoGenerated = afterCount > beforeCount;
    
    console.log(`ğŸ“ í‰ê°€ê¸°ì¤€ ìë™ìƒì„± ê²€ì¦: ${beforeCount}ê°œ â†’ ${afterCount}ê°œ`);
    expect(criteriaAutoGenerated).toBe(true);
    console.log(`âœ… í‰ê°€ê¸°ì¤€ ìë™ìƒì„± í™•ì¸: ${criteriaAutoGenerated ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}`);

    // 6. ìƒì„±ëœ í‰ê°€ê¸°ì¤€ ìƒì„¸ ê²€ì¦
    if (criteriaAutoGenerated) {
      const newCriteria = criteriaAfterAssignment.criteria.find(
        (c: any) => !criteriaBeforeAssignment?.criteria?.some((existing: any) => existing.id === c.id)
      );
      
      expect(newCriteria).toBeDefined();
      expect(newCriteria.wbsItemId).toBe(wbsItemId);
      expect(newCriteria.criteria).toBe(''); // ë¹ˆ í‰ê°€ê¸°ì¤€ìœ¼ë¡œ ìƒì„±ë¨
      expect(newCriteria.importance).toBe(5); // ê¸°ë³¸ ì¤‘ìš”ë„
      console.log(`âœ… ìë™ìƒì„±ëœ í‰ê°€ê¸°ì¤€ ê²€ì¦ ì™„ë£Œ: ID=${newCriteria.id}`);
    }

    console.log(`âœ… WBS í• ë‹¹ í›„ í‰ê°€ê¸°ì¤€ ìë™ìƒì„± ê²€ì¦ ì™„ë£Œ - í• ë‹¹: ${assignment.id}, í‰ê°€ê¸°ì¤€ ìë™ìƒì„±: ${criteriaAutoGenerated}`);

    return {
      assignmentCreated: true,
      criteriaAutoGenerated,
      verifiedEndpoints: 2, // WBS í• ë‹¹ + í‰ê°€ê¸°ì¤€ ì¡°íšŒ
    };
  }

  /**
   * WBS í• ë‹¹ í›„ í‰ê°€ê¸°ì¤€ ìˆ˜ì • ê²€ì¦ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
   */
  async WBS_í• ë‹¹_í›„_í‰ê°€ê¸°ì¤€_ìˆ˜ì •_ê²€ì¦_ì‹œë‚˜ë¦¬ì˜¤ë¥¼_ì‹¤í–‰í•œë‹¤(
    periodId: string,
    employeeId: string,
    wbsItemId: string,
    projectId: string,
  ): Promise<{
    assignmentCreated: boolean;
    criteriaModified: boolean;
    verifiedEndpoints: number;
  }> {
    console.log('ğŸ“ WBS í• ë‹¹ í›„ í‰ê°€ê¸°ì¤€ ìˆ˜ì • ê²€ì¦ ì‹œë‚˜ë¦¬ì˜¤');

    // 1. WBS í• ë‹¹ ë° í‰ê°€ê¸°ì¤€ ìë™ìƒì„±
    const autoGenResult = await this.WBS_í• ë‹¹_í›„_í‰ê°€ê¸°ì¤€_ìë™ìƒì„±_ê²€ì¦_ì‹œë‚˜ë¦¬ì˜¤ë¥¼_ì‹¤í–‰í•œë‹¤(
      periodId,
      employeeId,
      wbsItemId,
      projectId,
    );

    if (!autoGenResult.criteriaAutoGenerated) {
      console.log('âš ï¸ í‰ê°€ê¸°ì¤€ ìë™ìƒì„±ì´ ì‹¤íŒ¨í•˜ì—¬ ìˆ˜ì • ê²€ì¦ì„ ê±´ë„ˆëœë‹ˆë‹¤');
      return {
        assignmentCreated: autoGenResult.assignmentCreated,
        criteriaModified: false,
        verifiedEndpoints: autoGenResult.verifiedEndpoints,
      };
    }

    // 2. í‰ê°€ê¸°ì¤€ ìˆ˜ì •
    const criteria = await this.WBS_í‰ê°€ê¸°ì¤€ì„_ì¡°íšŒí•œë‹¤(wbsItemId);
    const targetCriteria = criteria[0]; // ì²« ë²ˆì§¸ í‰ê°€ê¸°ì¤€ ìˆ˜ì •

    const updatedCriteria = await this.testSuite
      .request()
      .patch(`/admin/evaluation-criteria/wbs-evaluation-criteria/${targetCriteria.id}`)
      .send({
        criteria: 'ìˆ˜ì •ëœ í‰ê°€ê¸°ì¤€ ë‚´ìš©',
        importance: 8,
      })
      .expect(200);

    console.log(`âœ… í‰ê°€ê¸°ì¤€ ìˆ˜ì • ì™„ë£Œ: ${targetCriteria.id}`);

    // 3. ìˆ˜ì •ëœ í‰ê°€ê¸°ì¤€ ê²€ì¦
    const modifiedCriteria = await this.WBS_í‰ê°€ê¸°ì¤€ì„_ì¡°íšŒí•œë‹¤(wbsItemId);
    const updatedItem = modifiedCriteria.find((c: any) => c.id === targetCriteria.id);
    
    expect(updatedItem).toBeDefined();
    expect(updatedItem.criteria).toBe('ìˆ˜ì •ëœ í‰ê°€ê¸°ì¤€ ë‚´ìš©');
    expect(updatedItem.importance).toBe(8);
    console.log(`âœ… í‰ê°€ê¸°ì¤€ ìˆ˜ì • ê²€ì¦ ì™„ë£Œ`);

    console.log(`âœ… WBS í• ë‹¹ í›„ í‰ê°€ê¸°ì¤€ ìˆ˜ì • ê²€ì¦ ì™„ë£Œ`);

    return {
      assignmentCreated: autoGenResult.assignmentCreated,
      criteriaModified: true,
      verifiedEndpoints: autoGenResult.verifiedEndpoints + 2, // ìˆ˜ì • + ì¡°íšŒ
    };
  }
}
