import { BaseE2ETest } from '../../../base-e2e.spec';
import { WbsAssignmentBasicScenario } from './wbs-assignment-basic.scenario';

/**
 * WBS í‰ê°€ê¸°ì¤€ ê´€ë¦¬ ì‹œë‚˜ë¦¬ì˜¤ í´ë˜ìŠ¤
 * 
 * WBS í‰ê°€ê¸°ì¤€ì˜ ìƒì„±, ì €ì¥, ì‚­ì œ, ì¬ì €ì¥ ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.
 */
export class WbsAssignmentEvaluationCriteriaManagementScenario {
  private basicScenario: WbsAssignmentBasicScenario;

  constructor(private readonly testSuite: BaseE2ETest) {
    this.basicScenario = new WbsAssignmentBasicScenario(testSuite);
  }

  /**
   * WBS í‰ê°€ê¸°ì¤€ì„ ì¡°íšŒí•©ë‹ˆë‹¤.
   */
  async WBS_í‰ê°€ê¸°ì¤€ì„_ì¡°íšŒí•œë‹¤(wbsItemId: string): Promise<any[]> {
    const response = await this.testSuite
      .request()
      .get(`/admin/evaluation-criteria/wbs-evaluation-criteria?wbsItemId=${wbsItemId}`)
      .expect(200);

    return response.body;
  }

  /**
   * WBS í•­ëª©ë³„ í‰ê°€ê¸°ì¤€ì„ ì¡°íšŒí•©ë‹ˆë‹¤.
   */
  async WBS_í•­ëª©ë³„_í‰ê°€ê¸°ì¤€ì„_ì¡°íšŒí•œë‹¤(wbsItemId: string): Promise<any> {
    const response = await this.testSuite
      .request()
      .get(`/admin/evaluation-criteria/wbs-evaluation-criteria/wbs-item/${wbsItemId}`)
      .expect(200);

    return response.body;
  }

  /**
   * WBS í‰ê°€ê¸°ì¤€ì„ ì €ì¥í•©ë‹ˆë‹¤ (Upsert).
   */
  async WBS_í‰ê°€ê¸°ì¤€ì„_ì €ì¥í•œë‹¤(
    wbsItemId: string,
    criteria: string,
    importance: number = 5,
  ): Promise<any> {
    const response = await this.testSuite
      .request()
      .post(`/admin/evaluation-criteria/wbs-evaluation-criteria/wbs-item/${wbsItemId}`)
      .send({
        criteria,
        importance,
      })
      .expect(200);

    return response.body;
  }

  /**
   * WBS í‰ê°€ê¸°ì¤€ì„ ì‚­ì œí•©ë‹ˆë‹¤.
   */
  async WBS_í‰ê°€ê¸°ì¤€ì„_ì‚­ì œí•œë‹¤(criteriaId: string): Promise<any> {
    const response = await this.testSuite
      .request()
      .delete(`/admin/evaluation-criteria/wbs-evaluation-criteria/${criteriaId}`)
      .expect(200);

    return response.body;
  }

  /**
   * WBS í•­ëª©ì˜ í‰ê°€ê¸°ì¤€ì„ ì „ì²´ ì‚­ì œí•©ë‹ˆë‹¤.
   */
  async WBS_í•­ëª©_í‰ê°€ê¸°ì¤€ì„_ì „ì²´ì‚­ì œí•œë‹¤(wbsItemId: string): Promise<any> {
    const response = await this.testSuite
      .request()
      .delete(`/admin/evaluation-criteria/wbs-evaluation-criteria/wbs-item/${wbsItemId}`)
      .expect(200);

    return response.body;
  }

  /**
   * WBS í• ë‹¹ í›„ í‰ê°€ê¸°ì¤€ ìë™ìƒì„±, ì €ì¥, ì‚­ì œ, ì¬ì €ì¥ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
   */
  async WBS_í‰ê°€ê¸°ì¤€_ìƒì„±_ì €ì¥_ì‚­ì œ_ì¬ì €ì¥_ì‹œë‚˜ë¦¬ì˜¤ë¥¼_ì‹¤í–‰í•œë‹¤(
    periodId: string,
    employeeId: string,
    wbsItemId: string,
    projectId: string,
  ): Promise<{
    assignmentCreated: boolean;
    autoGeneratedCriteria: boolean;
    criteriaSaved: boolean;
    criteriaDeleted: boolean;
    criteriaReSaved: boolean;
    verifiedEndpoints: number;
    criteriaDetails?: {
      autoGeneratedId?: string;
      savedId?: string;
      reSavedId?: string;
    };
  }> {
    console.log('ğŸ“ WBS í‰ê°€ê¸°ì¤€ ìƒì„±-ì €ì¥-ì‚­ì œ-ì¬ì €ì¥ ì‹œë‚˜ë¦¬ì˜¤');

    let verifiedEndpoints = 0;

    // 1. í”„ë¡œì íŠ¸ í• ë‹¹ ë¨¼ì € ìƒì„±
    console.log('ğŸ“ 1. í”„ë¡œì íŠ¸ í• ë‹¹ ìƒì„± ì¤‘...');
    await this.basicScenario.í”„ë¡œì íŠ¸ë¥¼_ëŒ€ëŸ‰ìœ¼ë¡œ_í• ë‹¹í•œë‹¤(periodId, [projectId], [employeeId]);
    console.log('âœ… í”„ë¡œì íŠ¸ í• ë‹¹ ì™„ë£Œ');

    // 2. WBS í• ë‹¹ ì „ í‰ê°€ê¸°ì¤€ ìƒíƒœ í™•ì¸
    console.log('ğŸ“ 2. WBS í• ë‹¹ ì „ í‰ê°€ê¸°ì¤€ ìƒíƒœ í™•ì¸');
    const criteriaBeforeAssignment = await this.WBS_í‰ê°€ê¸°ì¤€ì„_ì¡°íšŒí•œë‹¤(wbsItemId);
    const beforeCount = criteriaBeforeAssignment?.length || 0;
    console.log(`ğŸ“ WBS í• ë‹¹ ì „ í‰ê°€ê¸°ì¤€ ìˆ˜: ${beforeCount}ê°œ`);
    verifiedEndpoints++;

    // 3. WBS í• ë‹¹ ìƒì„± (ìë™ìœ¼ë¡œ í‰ê°€ê¸°ì¤€ ìƒì„±ë¨)
    console.log('ğŸ“ 3. WBS í• ë‹¹ ìƒì„± (ìë™ í‰ê°€ê¸°ì¤€ ìƒì„±)');
    const assignment = await this.basicScenario.WBS_í• ë‹¹ì„_ìƒì„±í•œë‹¤(
      employeeId,
      wbsItemId,
      projectId,
      periodId,
    );
    console.log(`âœ… WBS í• ë‹¹ ìƒì„± ì™„ë£Œ: ${assignment.id}`);

    // 4. WBS í• ë‹¹ í›„ í‰ê°€ê¸°ì¤€ ìë™ìƒì„± í™•ì¸
    console.log('ğŸ“ 4. WBS í• ë‹¹ í›„ í‰ê°€ê¸°ì¤€ ìë™ìƒì„± í™•ì¸');
    const criteriaAfterAssignment = await this.WBS_í‰ê°€ê¸°ì¤€ì„_ì¡°íšŒí•œë‹¤(wbsItemId);
    const afterCount = criteriaAfterAssignment?.length || 0;
    console.log(`ğŸ“ WBS í• ë‹¹ í›„ í‰ê°€ê¸°ì¤€ ìˆ˜: ${afterCount}ê°œ`);
    verifiedEndpoints++;

    const autoGeneratedCriteria = afterCount > beforeCount;
    let autoGeneratedId: string | undefined;

    if (autoGeneratedCriteria) {
      // ìë™ìƒì„±ëœ í‰ê°€ê¸°ì¤€ ID ì¶”ì¶œ
      const newCriteria = criteriaAfterAssignment.find(
        (c: any) => !criteriaBeforeAssignment?.some((existing: any) => existing.id === c.id)
      );
      autoGeneratedId = newCriteria?.id;
      console.log(`âœ… í‰ê°€ê¸°ì¤€ ìë™ìƒì„± í™•ì¸: ${afterCount - beforeCount}ê°œ ìƒì„±, ID: ${autoGeneratedId}`);
    } else {
      console.log(`âš ï¸ í‰ê°€ê¸°ì¤€ ìë™ìƒì„± ì‹¤íŒ¨ - í˜„ì¬ ì‹œìŠ¤í…œ ì œí•œ`);
    }

    // 5. í‰ê°€ê¸°ì¤€ ì €ì¥ (Upsert) í…ŒìŠ¤íŠ¸
    console.log('ğŸ“ 5. í‰ê°€ê¸°ì¤€ ì €ì¥ (Upsert) í…ŒìŠ¤íŠ¸');
    let criteriaSaved = false;
    let savedId: string | undefined;

    try {
      const savedCriteria = await this.WBS_í‰ê°€ê¸°ì¤€ì„_ì €ì¥í•œë‹¤(
        wbsItemId,
        'ìˆ˜ë™ìœ¼ë¡œ ì €ì¥í•œ í‰ê°€ê¸°ì¤€',
        8,
      );
      criteriaSaved = true;
      savedId = savedCriteria.id;
      console.log(`âœ… í‰ê°€ê¸°ì¤€ ì €ì¥ ì™„ë£Œ: ID=${savedId}, criteria="${savedCriteria.criteria}", importance=${savedCriteria.importance}`);
    } catch (error) {
      console.log(`âŒ í‰ê°€ê¸°ì¤€ ì €ì¥ ì‹¤íŒ¨:`, error.message);
    }
    verifiedEndpoints++;

    // 5.5. ëŒ€ì‹œë³´ë“œì—ì„œ í‰ê°€ê¸°ì¤€ ì €ì¥ ë³€ê²½ì‚¬í•­ ê²€ì¦
    console.log('ğŸ“ 5.5. ëŒ€ì‹œë³´ë“œì—ì„œ í‰ê°€ê¸°ì¤€ ì €ì¥ ë³€ê²½ì‚¬í•­ ê²€ì¦');
    const saveVerification = await this.basicScenario.í‰ê°€ê¸°ì¤€_ë³€ê²½ì‚¬í•­ì„_ëŒ€ì‹œë³´ë“œì—ì„œ_ê²€ì¦í•œë‹¤(
      periodId,
      employeeId,
      wbsItemId,
      {
        beforeCount: afterCount,
        afterCount: afterCount + 1, // ì €ì¥ìœ¼ë¡œ ì¸í•œ ì¦ê°€
        expectedCriteria: 'ìˆ˜ë™ìœ¼ë¡œ ì €ì¥í•œ í‰ê°€ê¸°ì¤€',
        expectedImportance: 8,
      },
    );
    verifiedEndpoints += saveVerification.verifiedEndpoints;
    console.log(`ğŸ“Š ì €ì¥ ë³€ê²½ì‚¬í•­ ê²€ì¦: ${saveVerification.criteriaChangeVerified ? 'âœ…' : 'âŒ'}`);

    // 6. ì €ì¥ëœ í‰ê°€ê¸°ì¤€ í™•ì¸
    console.log('ğŸ“ 6. ì €ì¥ëœ í‰ê°€ê¸°ì¤€ í™•ì¸');
    const criteriaAfterSave = await this.WBS_í‰ê°€ê¸°ì¤€ì„_ì¡°íšŒí•œë‹¤(wbsItemId);
    const saveCount = criteriaAfterSave?.length || 0;
    console.log(`ğŸ“ ì €ì¥ í›„ í‰ê°€ê¸°ì¤€ ìˆ˜: ${saveCount}ê°œ`);
    verifiedEndpoints++;

    // 7. í‰ê°€ê¸°ì¤€ ì‚­ì œ í…ŒìŠ¤íŠ¸
    console.log('ğŸ“ 7. í‰ê°€ê¸°ì¤€ ì‚­ì œ í…ŒìŠ¤íŠ¸');
    let criteriaDeleted = false;

    if (savedId) {
      try {
        const deleteResult = await this.WBS_í‰ê°€ê¸°ì¤€ì„_ì‚­ì œí•œë‹¤(savedId);
        criteriaDeleted = deleteResult.success;
        console.log(`âœ… í‰ê°€ê¸°ì¤€ ì‚­ì œ ì™„ë£Œ: ${criteriaDeleted ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}`);
      } catch (error) {
        console.log(`âŒ í‰ê°€ê¸°ì¤€ ì‚­ì œ ì‹¤íŒ¨:`, error.message);
      }
    } else {
      console.log(`âš ï¸ ì‚­ì œí•  í‰ê°€ê¸°ì¤€ IDê°€ ì—†ì–´ ì‚­ì œ í…ŒìŠ¤íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤`);
    }
    verifiedEndpoints++;

    // 8. ì‚­ì œ í›„ í‰ê°€ê¸°ì¤€ ìƒíƒœ í™•ì¸
    console.log('ğŸ“ 8. ì‚­ì œ í›„ í‰ê°€ê¸°ì¤€ ìƒíƒœ í™•ì¸');
    const criteriaAfterDelete = await this.WBS_í‰ê°€ê¸°ì¤€ì„_ì¡°íšŒí•œë‹¤(wbsItemId);
    const deleteCount = criteriaAfterDelete?.length || 0;
    console.log(`ğŸ“ ì‚­ì œ í›„ í‰ê°€ê¸°ì¤€ ìˆ˜: ${deleteCount}ê°œ`);
    verifiedEndpoints++;

    // 8.5. ëŒ€ì‹œë³´ë“œì—ì„œ í‰ê°€ê¸°ì¤€ ì‚­ì œ ë³€ê²½ì‚¬í•­ ê²€ì¦
    console.log('ğŸ“ 8.5. ëŒ€ì‹œë³´ë“œì—ì„œ í‰ê°€ê¸°ì¤€ ì‚­ì œ ë³€ê²½ì‚¬í•­ ê²€ì¦');
    const deleteVerification = await this.basicScenario.í‰ê°€ê¸°ì¤€_ë³€ê²½ì‚¬í•­ì„_ëŒ€ì‹œë³´ë“œì—ì„œ_ê²€ì¦í•œë‹¤(
      periodId,
      employeeId,
      wbsItemId,
      {
        beforeCount: saveCount,
        afterCount: deleteCount,
      },
    );
    verifiedEndpoints += deleteVerification.verifiedEndpoints;
    console.log(`ğŸ“Š ì‚­ì œ ë³€ê²½ì‚¬í•­ ê²€ì¦: ${deleteVerification.criteriaChangeVerified ? 'âœ…' : 'âŒ'}`);

    // 9. í‰ê°€ê¸°ì¤€ ì¬ì €ì¥ í…ŒìŠ¤íŠ¸
    console.log('ğŸ“ 9. í‰ê°€ê¸°ì¤€ ì¬ì €ì¥ í…ŒìŠ¤íŠ¸');
    let criteriaReSaved = false;
    let reSavedId: string | undefined;

    try {
      const reSavedCriteria = await this.WBS_í‰ê°€ê¸°ì¤€ì„_ì €ì¥í•œë‹¤(
        wbsItemId,
        'ì¬ì €ì¥í•œ í‰ê°€ê¸°ì¤€',
        9,
      );
      criteriaReSaved = true;
      reSavedId = reSavedCriteria.id;
      console.log(`âœ… í‰ê°€ê¸°ì¤€ ì¬ì €ì¥ ì™„ë£Œ: ID=${reSavedId}, criteria="${reSavedCriteria.criteria}", importance=${reSavedCriteria.importance}`);
    } catch (error) {
      console.log(`âŒ í‰ê°€ê¸°ì¤€ ì¬ì €ì¥ ì‹¤íŒ¨:`, error.message);
    }
    verifiedEndpoints++;

    // 10. ìµœì¢… í‰ê°€ê¸°ì¤€ ìƒíƒœ í™•ì¸
    console.log('ğŸ“ 10. ìµœì¢… í‰ê°€ê¸°ì¤€ ìƒíƒœ í™•ì¸');
    const finalCriteria = await this.WBS_í‰ê°€ê¸°ì¤€ì„_ì¡°íšŒí•œë‹¤(wbsItemId);
    const finalCount = finalCriteria?.length || 0;
    console.log(`ğŸ“ ìµœì¢… í‰ê°€ê¸°ì¤€ ìˆ˜: ${finalCount}ê°œ`);
    verifiedEndpoints++;

    // 10.5. ëŒ€ì‹œë³´ë“œì—ì„œ í‰ê°€ê¸°ì¤€ ì¬ì €ì¥ ë³€ê²½ì‚¬í•­ ê²€ì¦
    console.log('ğŸ“ 10.5. ëŒ€ì‹œë³´ë“œì—ì„œ í‰ê°€ê¸°ì¤€ ì¬ì €ì¥ ë³€ê²½ì‚¬í•­ ê²€ì¦');
    const reSaveVerification = await this.basicScenario.í‰ê°€ê¸°ì¤€_ë³€ê²½ì‚¬í•­ì„_ëŒ€ì‹œë³´ë“œì—ì„œ_ê²€ì¦í•œë‹¤(
      periodId,
      employeeId,
      wbsItemId,
      {
        beforeCount: deleteCount,
        afterCount: finalCount,
        expectedCriteria: 'ì¬ì €ì¥í•œ í‰ê°€ê¸°ì¤€',
        expectedImportance: 9,
      },
    );
    verifiedEndpoints += reSaveVerification.verifiedEndpoints;
    console.log(`ğŸ“Š ì¬ì €ì¥ ë³€ê²½ì‚¬í•­ ê²€ì¦: ${reSaveVerification.criteriaChangeVerified ? 'âœ…' : 'âŒ'}`);

    // 11. WBS í•­ëª©ë³„ í‰ê°€ê¸°ì¤€ ì¡°íšŒ í…ŒìŠ¤íŠ¸
    console.log('ğŸ“ 11. WBS í•­ëª©ë³„ í‰ê°€ê¸°ì¤€ ì¡°íšŒ í…ŒìŠ¤íŠ¸');
    try {
      const wbsItemCriteria = await this.WBS_í•­ëª©ë³„_í‰ê°€ê¸°ì¤€ì„_ì¡°íšŒí•œë‹¤(wbsItemId);
      console.log(`âœ… WBS í•­ëª©ë³„ í‰ê°€ê¸°ì¤€ ì¡°íšŒ ì™„ë£Œ: wbsItemId=${wbsItemCriteria.wbsItemId}, criteria ìˆ˜=${wbsItemCriteria.criteria?.length || 0}ê°œ`);
    } catch (error) {
      console.log(`âŒ WBS í•­ëª©ë³„ í‰ê°€ê¸°ì¤€ ì¡°íšŒ ì‹¤íŒ¨:`, error.message);
    }
    verifiedEndpoints++;

    console.log(`âœ… WBS í‰ê°€ê¸°ì¤€ ìƒì„±-ì €ì¥-ì‚­ì œ-ì¬ì €ì¥ ì‹œë‚˜ë¦¬ì˜¤ ì™„ë£Œ`);
    console.log(`ğŸ“Š ì‹œë‚˜ë¦¬ì˜¤ ê²°ê³¼:`);
    console.log(`  - WBS í• ë‹¹: âœ…`);
    console.log(`  - í‰ê°€ê¸°ì¤€ ìë™ìƒì„±: ${autoGeneratedCriteria ? 'âœ…' : 'âŒ'}`);
    console.log(`  - í‰ê°€ê¸°ì¤€ ì €ì¥: ${criteriaSaved ? 'âœ…' : 'âŒ'}`);
    console.log(`  - í‰ê°€ê¸°ì¤€ ì‚­ì œ: ${criteriaDeleted ? 'âœ…' : 'âŒ'}`);
    console.log(`  - í‰ê°€ê¸°ì¤€ ì¬ì €ì¥: ${criteriaReSaved ? 'âœ…' : 'âŒ'}`);
    console.log(`  - ê²€ì¦ëœ ì—”ë“œí¬ì¸íŠ¸: ${verifiedEndpoints}ê°œ`);

    return {
      assignmentCreated: true,
      autoGeneratedCriteria,
      criteriaSaved,
      criteriaDeleted,
      criteriaReSaved,
      verifiedEndpoints,
      criteriaDetails: {
        autoGeneratedId,
        savedId,
        reSavedId,
      },
    };
  }

  /**
   * WBS í•­ëª© í‰ê°€ê¸°ì¤€ ì „ì²´ ì‚­ì œ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
   */
  async WBS_í•­ëª©_í‰ê°€ê¸°ì¤€_ì „ì²´ì‚­ì œ_ì‹œë‚˜ë¦¬ì˜¤ë¥¼_ì‹¤í–‰í•œë‹¤(
    periodId: string,
    employeeId: string,
    wbsItemId: string,
    projectId: string,
  ): Promise<{
    assignmentCreated: boolean;
    criteriaCreated: boolean;
    criteriaBulkDeleted: boolean;
    verifiedEndpoints: number;
  }> {
    console.log('ğŸ“ WBS í•­ëª© í‰ê°€ê¸°ì¤€ ì „ì²´ì‚­ì œ ì‹œë‚˜ë¦¬ì˜¤');

    let verifiedEndpoints = 0;

    // 1. í”„ë¡œì íŠ¸ í• ë‹¹ ë¨¼ì € ìƒì„±
    console.log('ğŸ“ 1. í”„ë¡œì íŠ¸ í• ë‹¹ ìƒì„± ì¤‘...');
    await this.basicScenario.í”„ë¡œì íŠ¸ë¥¼_ëŒ€ëŸ‰ìœ¼ë¡œ_í• ë‹¹í•œë‹¤(periodId, [projectId], [employeeId]);
    console.log('âœ… í”„ë¡œì íŠ¸ í• ë‹¹ ì™„ë£Œ');

    // 2. WBS í• ë‹¹ ìƒì„±
    console.log('ğŸ“ 2. WBS í• ë‹¹ ìƒì„±');
    const assignment = await this.basicScenario.WBS_í• ë‹¹ì„_ìƒì„±í•œë‹¤(
      employeeId,
      wbsItemId,
      projectId,
      periodId,
    );
    console.log(`âœ… WBS í• ë‹¹ ìƒì„± ì™„ë£Œ: ${assignment.id}`);

    // 3. ì—¬ëŸ¬ í‰ê°€ê¸°ì¤€ ìƒì„±
    console.log('ğŸ“ 3. ì—¬ëŸ¬ í‰ê°€ê¸°ì¤€ ìƒì„±');
    const criteriaToCreate = [
      { criteria: 'ì²« ë²ˆì§¸ í‰ê°€ê¸°ì¤€', importance: 5 },
      { criteria: 'ë‘ ë²ˆì§¸ í‰ê°€ê¸°ì¤€', importance: 7 },
      { criteria: 'ì„¸ ë²ˆì§¸ í‰ê°€ê¸°ì¤€', importance: 9 },
    ];

    const createdCriteriaIds: string[] = [];
    for (const criteriaData of criteriaToCreate) {
      try {
        const savedCriteria = await this.WBS_í‰ê°€ê¸°ì¤€ì„_ì €ì¥í•œë‹¤(
          wbsItemId,
          criteriaData.criteria,
          criteriaData.importance,
        );
        createdCriteriaIds.push(savedCriteria.id);
        console.log(`âœ… í‰ê°€ê¸°ì¤€ ìƒì„±: ${criteriaData.criteria} (ID: ${savedCriteria.id})`);
      } catch (error) {
        console.log(`âŒ í‰ê°€ê¸°ì¤€ ìƒì„± ì‹¤íŒ¨: ${criteriaData.criteria}`, error.message);
      }
    }
    verifiedEndpoints += criteriaToCreate.length;

    // 4. ìƒì„±ëœ í‰ê°€ê¸°ì¤€ í™•ì¸
    console.log('ğŸ“ 4. ìƒì„±ëœ í‰ê°€ê¸°ì¤€ í™•ì¸');
    const criteriaAfterCreate = await this.WBS_í‰ê°€ê¸°ì¤€ì„_ì¡°íšŒí•œë‹¤(wbsItemId);
    const createCount = criteriaAfterCreate?.length || 0;
    console.log(`ğŸ“ ìƒì„± í›„ í‰ê°€ê¸°ì¤€ ìˆ˜: ${createCount}ê°œ`);
    verifiedEndpoints++;

    // 5. WBS í•­ëª© í‰ê°€ê¸°ì¤€ ì „ì²´ ì‚­ì œ
    console.log('ğŸ“ 5. WBS í•­ëª© í‰ê°€ê¸°ì¤€ ì „ì²´ ì‚­ì œ');
    let criteriaBulkDeleted = false;

    try {
      const deleteResult = await this.WBS_í•­ëª©_í‰ê°€ê¸°ì¤€ì„_ì „ì²´ì‚­ì œí•œë‹¤(wbsItemId);
      criteriaBulkDeleted = deleteResult.success;
      console.log(`âœ… WBS í•­ëª© í‰ê°€ê¸°ì¤€ ì „ì²´ ì‚­ì œ ì™„ë£Œ: ${criteriaBulkDeleted ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}`);
    } catch (error) {
      console.log(`âŒ WBS í•­ëª© í‰ê°€ê¸°ì¤€ ì „ì²´ ì‚­ì œ ì‹¤íŒ¨:`, error.message);
    }
    verifiedEndpoints++;

    // 6. ì‚­ì œ í›„ í‰ê°€ê¸°ì¤€ ìƒíƒœ í™•ì¸
    console.log('ğŸ“ 6. ì‚­ì œ í›„ í‰ê°€ê¸°ì¤€ ìƒíƒœ í™•ì¸');
    const criteriaAfterDelete = await this.WBS_í‰ê°€ê¸°ì¤€ì„_ì¡°íšŒí•œë‹¤(wbsItemId);
    const deleteCount = criteriaAfterDelete?.length || 0;
    console.log(`ğŸ“ ì „ì²´ ì‚­ì œ í›„ í‰ê°€ê¸°ì¤€ ìˆ˜: ${deleteCount}ê°œ`);
    verifiedEndpoints++;

    console.log(`âœ… WBS í•­ëª© í‰ê°€ê¸°ì¤€ ì „ì²´ì‚­ì œ ì‹œë‚˜ë¦¬ì˜¤ ì™„ë£Œ`);
    console.log(`ğŸ“Š ì‹œë‚˜ë¦¬ì˜¤ ê²°ê³¼:`);
    console.log(`  - WBS í• ë‹¹: âœ…`);
    console.log(`  - í‰ê°€ê¸°ì¤€ ìƒì„±: ${createdCriteriaIds.length}/${criteriaToCreate.length}ê°œ`);
    console.log(`  - í‰ê°€ê¸°ì¤€ ì „ì²´ ì‚­ì œ: ${criteriaBulkDeleted ? 'âœ…' : 'âŒ'}`);
    console.log(`  - ê²€ì¦ëœ ì—”ë“œí¬ì¸íŠ¸: ${verifiedEndpoints}ê°œ`);

    return {
      assignmentCreated: true,
      criteriaCreated: createdCriteriaIds.length > 0,
      criteriaBulkDeleted,
      verifiedEndpoints,
    };
  }
}
